<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FollowBuddy</title>

  <!-- Favicon -->
<link rel="icon" href="/faviconfollowbuddy.ico" type="image/x-icon">
  <!-- Original .ico favicon (kept for reference, but SVG is recommended) -->
  <!-- <link rel="icon" href="faviconfollowbuddy.ico" type="image/x-icon"> -->

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    /* Custom CSS for Inter font and general body styles */
    body {
      font-family: 'Inter', sans-serif;
      background: #1a202c; /* Dark background */
      color: #e2e8f0; /* Light text color */
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    /* Hide scrollbar for a cleaner look */
    body::-webkit-scrollbar {
      display: none;
    }
    body {
      -ms-overflow-style: none;
      /* IE and Edge */
      scrollbar-width: none;
      /* Firefox */
    }
    /* Custom styles for the file upload area */
    .upload-area {
      border: 2px dashed #4a5568; /* Darker slate-500 */
      background-color: #2d3748; /* Darker slate-800 */
      transition: all 0.2s ease-in-out;
    }
    .upload-area.drag-over {
      background-color: #4a5568; /* Darker slate-700 */
      border-color: #6366f1; /* Indigo-500 */
    }
    /* Custom modal styles */
    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1000; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgba(0,0,0,0.6); /* Darker overlay */
        justify-content: center;
        align-items: center;
    }
    .modal-content {
        background-color: #2d3748; /* Default dark background for modal */
        margin: auto;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        width: 80%;
        max-width: 400px;
        text-align: center;
        color: #e2e8f0; /* Default light text color */
    }
    /* Adjusted for Safe Users modal */
    #safe-users-modal .modal-content,
    #banned-users-add-modal .modal-content,
    #unfollowed-profiles-modal .modal-content { /* Apply to banned users add modal and new add account modal too */
        max-width: 600px; /* Wider for bulk input */
    }
    /* Modal content themes */
    .modal-content.modal-success {
        background-color: #10B981; /* Green-500 */
        color: #ffffff;
    }
    .modal-content.modal-error {
        background-color: #EF4444; /* Red-500 */
        color: #ffffff;
    }
    .modal-content.modal-info {
        background-color: #3B82F6; /* Blue-500 */
        color: #ffffff;
    }
    /* Adjust alert message text color for themed modals */
    .modal-content.modal-success #alert-message,
    .modal-content.modal-error #alert-message,
    .modal-content.modal-info #alert-message {
        color: inherit; /* Inherit color from parent modal-content */
    }

    .close-button {
        color: #94a3b8;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }
    .close-button:hover,
    .close-button:focus {
        color: #e2e8f0;
        text-decoration: none;
        cursor: pointer;
    }
    /* Dashboard specific styles */
    .dashboard-sidebar {
      width: 60px; /* Collapsed width */
      flex-shrink: 0;
      background-color: #2d3748; /* Darker sidebar */
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      padding: 20px 0; /* Adjust padding for vertical centering of icons */
      transition: width 0.3s ease-in-out; /* Smooth transition */
      overflow: hidden; /* Hide overflowing text */
      display: flex; /* Use flexbox for internal layout */
      flex-direction: column;
      align-items: center; /* Center items horizontally in collapsed state */
    }

    .dashboard-sidebar:hover {
      width: 250px; /* Expanded width */
      align-items: flex-start; /* Align items to start when expanded */
    }

    .dashboard-sidebar nav {
      width: 100%; /* Ensure nav takes full width for hover effect */
    }

    .dashboard-sidebar nav ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .dashboard-sidebar nav ul li {
      margin-bottom: 10px; /* Spacing between nav items */
      width: 100%; /* Ensure full width for hover effect */
    }

    .dashboard-sidebar nav ul li a {
      white-space: nowrap;
      display: flex;
      align-items: center;
      justify-content: center; /* Center icon in collapsed state */
      padding: 10px 0; /* Vertical padding, no horizontal padding initially */
      border-radius: 8px;
      color: #e2e8f0; /* Default text color */
      transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, padding 0.3s ease-in-out;
    }

    .dashboard-sidebar:hover nav ul li a {
      justify-content: flex-start; /* Align to start when expanded */
      padding: 10px 15px; /* Add horizontal padding when expanded */
    }

    .dashboard-sidebar nav ul li a i {
      margin-right: 0; /* No margin initially */
      font-size: 1.2rem;
      transition: margin-right 0.3s ease-in-out;
    }

    .dashboard-sidebar:hover nav ul li a i {
      margin-right: 15px; /* Add margin when expanded */
    }

    .dashboard-sidebar nav ul li a span {
      opacity: 0;
      width: 0; /* Collapse text width */
      overflow: hidden; /* Hide text overflow */
      transition: opacity 0.3s ease-in-out, width 0.3s ease-in-out;
    }

    .dashboard-sidebar:hover nav ul li a span {
      opacity: 1;
      width: auto; /* Expand text width */
    }

    /* Navigation Heading specific styles */
    .dashboard-sidebar .nav-heading {
        display: flex;
        align-items: center;
        justify-content: center; /* Center icon initially */
        margin-bottom: 20px;
        color: #e2e8f0;
        font-weight: bold;
        font-size: 1.2rem;
        padding: 0 10px; /* Adjust padding */
        transition: justify-content 0.3s ease-in-out, padding 0.3s ease-in-out;
        min-height: 1.5rem; /* Ensure consistent height for spacing */
    }

    .dashboard-sidebar:hover .nav-heading {
        justify-content: flex-start; /* Align to start on hover */
        padding: 0 15px; /* Adjust padding on hover */
    }

    .dashboard-sidebar .nav-heading i {
        font-size: 1.5rem; /* Larger icon for heading */
        margin-right: 0; /* No margin initially */
        transition: margin-right 0.3s ease-in-out;
        display: none; /* Keep hidden as per request */
    }

    .dashboard-sidebar:hover .nav-heading i {
        margin-right: 10px; /* Add margin on hover */
        display: none; /* Keep hidden as per request */
    }

    .dashboard-sidebar .nav-heading span {
        opacity: 0;
        width: 0;
        overflow: hidden;
        transition: opacity 0.3s ease-in-out, width 0.3s ease-in-out;
    }

    .dashboard-sidebar:hover .nav-heading span {
        opacity: 1;
        width: auto;
    }
    /* Logo in sidebar */
    .dashboard-sidebar .logo-container {
        padding: 10px 0;
        margin-bottom: 20px;
        display: flex;
        justify-content: center;
        width: 100%;
    }

    .dashboard-sidebar:hover .logo-container {
        justify-content: flex-start;
        padding: 10px 15px;
    }

    .dashboard-sidebar .logo-container img {
        width: 40px; /* Adjust size as needed */
        height: 40px;
        border-radius: 8px; /* Rounded corners for the logo */
        transition: width 0.3s ease-in-out, height 0.3s ease-in-out;
    }

    .dashboard-sidebar:hover .logo-container img {
        width: 50px;
        height: 50px;
    }

    .dashboard-sidebar .logo-container span {
        opacity: 0;
        width: 0;
        overflow: hidden;
        white-space: nowrap;
        margin-left: 0;
        font-size: 1.5rem;
        font-weight: bold;
        color: #e2e8f0;
        transition: opacity 0.3s ease-in-out, width 0.3s ease-in-out, margin-left 0.3s ease-in-out;
    }

    .dashboard-sidebar:hover .logo-container span {
        opacity: 1;
        width: auto;
        margin-left: 10px;
    }


    .dashboard-content {
      flex-grow: 1;
      padding: 20px;
      background-color: #1a202c; /* Dark background */
    }
    .metric-card {
      background-color: #2d3748; /* Darker card background */
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 20px;
      text-align: center;
      color: #e2e8f0; /* Light text color */
      cursor: pointer; /* Indicate clickable */
      transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .metric-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .metric-card .value {
      font-size: 2.5rem;
      font-weight: bold;
      color: #6366f1; /* Indigo-500 */
    }
    .metric-card.not-following-back .value { /* Specific style for not-following-back metric */
      color: #ef4444; /* red-500 */
    }
    .metric-card .value-main {
        font-size: 2.5rem;
        font-weight: bold;
        color: #f97316; /* Orange-500 */
    }
    .metric-card .value-sub {
        font-size: 1rem;
        color: #ef4444; /* Red-500 */
        margin-top: -0.5rem; /* Pull it up slightly */
        text-align: center; /* Centered below main value */
        padding-right: 0; /* Remove padding */
    }
    .metric-card .label {
      font-size: 1rem;
      color: #94a3b8; /* slate-400 */
    }
    .account-list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #4a5568; /* Darker border */
    }
    .account-list-item:last-child {
      border-bottom: none;
    }
    /* Custom style for valid ZIP file background */
    .valid-zip-background {
        background-color: rgba(34, 197, 94, 0.5); /* green-500 with 50% opacity */
        padding: 2px 8px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        margin-left: 0.5rem; /* ml-2 */
    }
    /* Style for the "Times" column in the table */
    .account-list-item .time-col {
        text-align: right; /* Align to the right */
        margin-left: auto; /* Pushes to the right */
        padding-right: 5px; /* Add some padding from the edge */
    }

    /* Accounts Management specific styles */
    .accounts-to-remove-green { color: #2fa351; }
    .accounts-to-remove-orange { color: #aa5728; }
    .accounts-to-remove-red { color: #ef4444; } /* Reusing existing red for consistency */

    .btn-remove {
        background-color: #ef4444; /* Red-500 */
        color: white;
        padding: 8px 16px;
        border-radius: 9999px; /* Full rounded */
        font-weight: bold;
        transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .btn-remove:hover {
        background-color: #dc2626; /* Red-600 */
        transform: translateY(-1px);
    }
    .btn-approve {
        background-color: #22c55e; /* Green-500 */
        color: white;
        padding: 8px 16px;
        border-radius: 9999px; /* Full rounded */
        font-weight: bold;
        transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .btn-approve:hover {
        background-color: #16a34a; /* Green-600 */
        transform: translateY(-1px);
    }

    /* Notification styles */
    .notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #22c55e; /* Green-500 */
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        z-index: 1000;
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.3s ease-out, transform 0.3s ease-out;
    }
    .notification.show {
        opacity: 1;
        transform: translateY(0);
    }
    /* Loading spinner for buttons */
    .button-spinner {
        display: none;
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    button.loading .button-text {
        display: none;
    }
    button.loading .button-spinner {
        display: block;
    }
  </style>
</head>
<body class="flex flex-col min-h-screen">

  <header class="bg-gray-900 shadow-sm py-4 px-6 flex justify-between items-center sticky top-0 z-50">
    <div class="flex items-center space-x-2">
      <i class="fas fa-users text-blue-400 text-2xl"></i>
      <a href="#" class="text-2xl font-bold text-gray-100">FollowBuddy</a>
    </div>
    <nav class="hidden md:flex space-x-8">
      <a href="#features" class="text-gray-300 hover:text-blue-400 transition-colors duration-200">Features</a>
      <a href="#upload" class="text-gray-300 hover:text-blue-400 transition-colors duration-200">Upload</a>
      <a href="#dashboard-section" id="dashboard-nav-link" class="text-gray-300 hover:text-blue-400 transition-colors duration-200 flex items-center">
        <i class="fas fa-tachometer-alt mr-2"></i><span>Dashboard</span>
      </a>
      <!-- New Banned Users Page Link in Header -->
      <a href="#banned-users-page-section" id="banned-users-nav-link" class="text-gray-300 hover:text-blue-400 transition-colors duration-200 flex items-center">
        <i class="fas fa-ban mr-2"></i><span>Banned Users</span>
      </a>
      <!-- New Add Account Link -->
      <a href="#add-account-page-section" id="add-account-nav-link" class="text-gray-300 hover:text-blue-400 transition-colors duration-200 flex items-center">
        <i class="fas fa-user-plus mr-2"></i><span>Add Account</span>
      </a>
    </nav>
    <div class="flex items-center space-x-4">
      <button id="login-btn-nav" class="hidden md:block text-blue-400 hover:text-blue-200 transition-colors duration-200 font-medium">Account</button>
      <button id="logout-btn-nav" class="hidden md:block bg-red-600 text-white px-4 py-2 rounded-lg shadow hover:bg-red-700 transition-colors duration-200 font-medium">Logout</button>
      <button id="access-premium-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors duration-200 font-medium">Access Premium</button>
    </div>
    <button id="mobile-menu-button" class="md:hidden text-gray-300 hover:text-blue-400 focus:outline-none">
      <i class="fas fa-bars text-xl"></i>
    </button>
  </header>

  <div id="mobile-menu" class="hidden fixed inset-0 bg-gray-900 z-40 flex flex-col items-center justify-center space-y-6 md:hidden">
    <button id="close-mobile-menu" class="absolute top-4 right-4 text-gray-300 hover:text-blue-400 focus:outline-none">
      <i class="fas fa-times-circle text-2xl"></i>
    </button>
    <a href="#features" class="text-gray-100 text-2xl hover:text-blue-400 transition-colors duration-200" onclick="document.getElementById('mobile-menu').classList.add('hidden')">Features</a>
    <a href="#upload" class="text-gray-100 text-2xl hover:text-blue-400 transition-colors duration-200" onclick="document.getElementById('mobile-menu').classList.add('hidden')">Upload</a>
    <a href="#dashboard-section" id="dashboard-nav-link-mobile" class="text-gray-100 text-2xl hover:text-blue-400 transition-colors duration-200 flex items-center">
        <i class="fas fa-tachometer-alt mr-2"></i><span>Dashboard</span>
    </a>
    <!-- New Banned Users Page Link in Mobile Menu -->
    <a href="#banned-users-page-section" id="banned-users-nav-link-mobile" class="text-gray-100 text-2xl hover:text-blue-400 transition-colors duration-200 flex items-center">
      <i class="fas fa-ban mr-2"></i><span>Banned Users</span>
    </a>
    <!-- New Add Account Link in Mobile Menu -->
    <a href="#add-account-page-section" id="add-account-nav-link-mobile" class="text-gray-100 text-2xl hover:text-blue-400 transition-colors duration-200 flex items-center">
      <i class="fas fa-user-plus mr-2"></i><span>Add Account</span>
    </a>
    <button id="login-btn-mobile" class="text-blue-400 text-2xl hover:text-blue-200 transition-colors duration-200 font-medium">Account</button>
    <button id="logout-btn-mobile" class="bg-red-600 text-white px-6 py-3 rounded-lg shadow hover:bg-red-700 transition-colors duration-200 font-medium text-2xl">Logout</button>
  </div>


  <section id="hero-section" class="bg-gradient-to-r from-blue-700 to-purple-800 text-white py-20 px-6 text-center">
    <h1 class="text-5xl font-extrabold mb-4 leading-tight">Find Out Who's Not Following You Back!</h1>
    <p class="text-xl mb-8 max-w-2xl mx-auto">Discover your unfollowers on Instagram safely and easily, without sharing your password.</p>
    <a href="#upload" class="bg-white text-blue-600 px-8 py-4 rounded-full text-lg font-bold shadow-lg hover:bg-gray-100 transition-all duration-300 transform hover:scale-105">Get Started Now</a>
  </section>

  <section id="features" class="py-16 px-6 bg-gray-800">
    <div class="max-w-6xl mx-auto">
      <h2 class="text-4xl font-bold text-center mb-12 text-gray-100">Core Features</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10">
        <div class="bg-gray-700 p-8 rounded-xl shadow-lg flex flex-col items-center text-center">
          <i class="fas fa-shield-alt text-5xl text-blue-400 mb-6"></i>
          <h3 class="text-2xl font-semibold mb-4 text-gray-100">Safe Unfollower Tracking</h3>
          <p class="text-gray-300">Identify who has unfollowed you on Instagram without risking your account with potentially unsafe third-party apps.</p>
        </div>
        <div class="bg-gray-700 p-8 rounded-xl shadow-lg flex flex-col items-center text-center">
          <i class="fab fa-instagram text-5xl text-purple-500 mb-6"></i>
          <h3 class="text-2xl font-semibold mb-4 text-gray-100">Full Instagram Compliance</h3>
          <p class="text-gray-300">Utilizes approved Instagram data and does not require users to enter their Instagram passwords, ensuring full compliance.</p>
        </div>
        <div class="bg-gray-700 p-8 rounded-xl shadow-lg flex flex-col items-center text-center">
          <i class="fas fa-lock text-5xl text-green-400 mb-6"></i>
          <h3 class="text-2xl font-semibold mb-4 text-gray-100">No Login Required</h3>
          <p class="text-gray-300">Users can track unfollowers without entering their Instagram login details, enhancing security and privacy.</p>
        </div>
        <div class="bg-gray-700 p-8 rounded-xl shadow-lg flex flex-col items-center text-center">
          <i class="fas fa-lightbulb text-5xl text-yellow-400 mb-6"></i>
          <h3 class="text-2xl font-semibold mb-4 text-gray-100">Simple and Easy to Use</h3>
          <p class="text-gray-300">The app is regularly updated with new features and improvements, including ways to visualize follower changes and reminders.</p>
        </div>
        <div class="bg-gray-700 p-8 rounded-xl shadow-lg flex flex-col items-center text-center">
          <i class="fas fa-headset text-5xl text-red-500 mb-6"></i>
          <h3 class="text-2xl font-semibold mb-4 text-gray-100">Real Human Support</h3>
          <p class="text-gray-300">FollowBuddy offers support from a real human team, not automated bots, for personalized assistance.</p>
        </div>
        <div class="bg-gray-700 p-8 rounded-xl shadow-lg flex flex-col items-center text-center">
          <i class="fas fa-sync-alt text-5xl text-indigo-400 mb-6"></i>
          <h3 class="text-2xl font-semibold mb-4 text-gray-100">Regular Updates</h3>
          <p class="text-gray-300">The app is regularly updated with new features and improvements, including ways to visualize follower changes and reminders.</p>
        </div>
      </div>
    </div>
  </section>

  <section id="upload" class="py-16 px-6 bg-gray-900 flex-grow flex items-center justify-center">
    <div class="bg-gray-800 p-8 rounded-xl shadow-lg max-w-2xl w-full text-center">
      <h2 class="text-3xl font-bold mb-8 text-gray-100">Find Out Who's Not Following You Back!</h2>

      <div id="initial-upload-area">
        <div id="upload-area" class="upload-area p-12 rounded-lg flex flex-col items-center justify-center mb-8">
          <i class="fas fa-cloud-upload-alt text-6xl text-gray-500 mb-4"></i>
          <p class="text-gray-400 text-lg mb-4">Upload your Instagram ZIP or HTML files</p>
          <p class="text-gray-500 mb-6">Drag and drop your file here, or click to browse</p>
          <input type="file" id="file-input" accept=".zip, .html" class="hidden" />
          <button id="choose-file-btn" class="bg-blue-600 text-white px-6 py-3 rounded-lg shadow hover:bg-blue-700 transition-colors duration-200 flex items-center space-x-2">
            <i class="fas fa-plus-circle"></i>
            <span>Choose File</span>
          </button>
        </div>
      </div>

      <div id="upload-success-state" class="hidden">
        <div class="border-2 border-green-500 bg-green-900 p-6 rounded-lg mb-8">
          <i class="fas fa-check-circle text-green-400 text-5xl mb-4"></i>
          <p class="text-green-200 text-xl font-semibold mb-2">File uploaded successfully!</p>
          <p class="text-green-300">Your file is ready for analysis. Click the button below to proceed.</p>
        </div>

        <div class="bg-gray-700 p-4 rounded-lg shadow-sm flex items-center justify-between mb-8 border border-gray-600">
          <div class="flex items-center space-x-3">
            <i class="fas fa-file-archive text-blue-400 text-2xl"></i>
            <div>
              <p id="uploaded-file-name" class="font-medium text-gray-100 text-left"></p>
              <p class="text-gray-400 text-sm flex items-center space-x-2">
                <span id="uploaded-file-size"></span>
                <span class="valid-zip-background"><i class="fas fa-check-circle mr-1"></i>Valid file</span>
              </p>
            </div>
          </div>
          <button id="remove-file-btn" class="text-gray-400 hover:text-red-500 transition-colors duration-200">
            <i class="fas fa-times-circle text-xl"></i>
          </button>
        </div>

        <button id="find-non-followers-btn" class="bg-blue-600 text-white px-8 py-4 rounded-full text-lg font-bold shadow-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 flex items-center justify-center mx-auto mb-4">
          Find My Non-Followers <i class="fas fa-arrow-right ml-3"></i>
        </button>
      </div>

      <!-- New "Download Your Info" Button -->
      <a href="https://accountscenter.instagram.com/info_and_permissions/dyi/?entry_point=notification" target="_blank" rel="noopener noreferrer"
         class="inline-flex items-center justify-center px-8 py-4 rounded-full text-lg font-bold shadow-2xl bg-gradient-to-r from-purple-600 to-indigo-600 text-white hover:from-purple-700 hover:to-indigo-700 transition-all duration-300 transform hover:scale-105 mb-8">
        <i class="fas fa-download mr-3"></i>
        <span>Download Your Info</span>
      </a>
      <!-- End New "Download Your Info" Button -->

      <div class="bg-blue-900 p-6 rounded-lg text-left text-blue-200">
        <p class="font-semibold mb-2"><i class="fas fa-info-circle mr-2"></i>File Requirements:</p>
        <ul class="list-disc list-inside space-y-1">
          <li>ZIP or HTML files (.zip, .html)</li>
          <li>Maximum size: 200MB (though larger files are handled by the script if browser memory allows)</li>
        </ul>
      </div>
    </div>
  </section>

  <section id="dashboard-section" class="hidden py-16 px-6 bg-gray-900">
    <div class="max-w-7xl mx-auto flex flex-col md:flex-row">
      <div class="dashboard-sidebar p-6 md:block hidden">
        <nav>
          <ul>
            <li class="mb-4">
              <a href="#" id="dashboard-link" class="flex items-center text-blue-400 font-semibold hover:text-blue-200 transition-colors duration-200">
                <i class="fas fa-home text-lg"></i><span>Home</span>
              </a>
            </li>
            <li class="mb-4">
              <a href="#" id="analytics-link-sidebar-dashboard" class="flex items-center text-gray-300 hover:text-blue-400 transition-colors duration-200">
                <i class="fas fa-chart-line text-lg"></i><span>Analytics</span>
              </a>
            </li>
            <li class="mb-4">
              <a href="#" id="accounts-link-sidebar-dashboard" class="flex items-center text-gray-300 hover:text-blue-400 transition-colors duration-200">
                <i class="fas fa-user-friends text-lg"></i><span>Accounts</span>
              </a>
            </li>
            <li class="mb-4">
              <a href="#banned-users-page-section" id="banned-users-link-sidebar-dashboard" class="flex items-center text-gray-300 hover:text-red-400 transition-colors duration-200">
                <i class="fas fa-ban text-lg"></i><span>Banned Users</span>
              </a>
            </li>
            <li class="mb-4">
              <a href="#" id="settings-link-sidebar-dashboard" class="flex items-center text-gray-300 hover:text-blue-400 transition-colors duration-200">
                <i class="fas fa-cog text-lg"></i><span>Settings</span>
              </a>
            </li>
          </ul>
        </nav>
      </div>

      <div class="dashboard-content">
        <div class="flex justify-between items-center mb-8">
          <h2 class="text-3xl font-bold text-gray-100">Your Instagram Dashboard</h2>
          <div class="flex items-center space-x-3">
            <select id="data-upload-selector-dashboard" class="border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-gray-100">
                <option value="">Select Data Upload</option>
            </select>
            <button id="safe-users-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 transition-colors duration-200 font-medium">
                <i class="fas fa-user-plus mr-2"></i>Safe Users
            </button>
            <button id="upload-new-data-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors duration-200 font-medium">
              <i class="fas fa-upload mr-2"></i>Upload New Data
            </button>
          </div>
        </div>

      <div class="flex-grow p-6 overflow-y-auto flex flex-col">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="metric-card" id="followers-card"> <p class="label">Total Followers</p>
              <p class="value" id="followers-count">0</p>
          </div>
          <div class="metric-card" id="following-card"> <p class="label">Total Following</p>
              <p class="value" id="following-count">0</p>
          </div>
          <div class="metric-card">
            <p class="label">Not Following Back</p>
            <p class="value-main" id="not-following-back-filtered-count">0</p>
            <p class="value-sub" id="not-following-back-total-count">/ 0</p>
          </div>
          <div class="metric-card" id="you-dont-follow-back-card">
            <p class="label">People You Unfollowed</p>
            <p class="value" id="you-dont-follow-back-count">0</p>
          </div>
        </div>
        </div>
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-100">Accounts Not Following You Back</h3>
            <div class="flex items-center space-x-4">
              <input type="text" id="search-input" placeholder="Search for a specific account..." class="border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-gray-100" />
              <select id="time-filter-select" class="border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-gray-100">
                <option value="all">All Times</option>
                <option value="green">Green (Recent)</option>
                <option value="orange">Orange (1-7 Days)</option>
                <option value="red">Red (>7 Days)</option>
              </select>
              <select id="sort-select" class="border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-gray-100">
                <option value="newest">Newest</option>
                <option value="oldest">Oldest</option>
                <option value="alpha-asc">Alphabetical (A-Z)</option>
                <option value="alpha-desc">Alphabetical (Z-A)</option>
                <option value="color">By Color</option>
              </select>
              <button class="text-gray-300 hover:text-blue-400"><i class="fas fa-download mr-2"></i>Download CSV</button>
            </div>
          </div>

          <div id="non-followers-list" class="space-y-2">
            <p id="no-data-message" class="text-gray-500 text-center">Upload your Instagram data to see who isn't following you back!</p>
          </div>
          <p class="text-gray-500 text-sm mt-4 text-center">Your User ID: <span id="user-id-display" class="font-mono text-gray-700 break-all">Loading...</span></p>
        </div>

        <!-- New Buttons for Opening Users by Color -->
        <div class="flex justify-center space-x-4 mt-8">
            <button id="open-green-users-btn" class="bg-green-600 text-white px-6 py-3 rounded-lg shadow hover:bg-green-700 transition-colors duration-200 font-medium">
                Open Green Users
            </button>
            <button id="open-orange-users-btn" class="bg-orange-600 text-white px-6 py-3 rounded-lg shadow hover:bg-orange-700 transition-colors duration-200 font-medium">
                Open Orange Users
            </button>
            <button id="open-red-users-btn" class="bg-red-600 text-white px-6 py-3 rounded-lg shadow hover:bg-red-700 transition-colors duration-200 font-medium">
                Open Red Users
            </button>
        </div>
      </div>
    </div>
  </section>

  <section id="analytics-section" class="hidden py-16 px-6 bg-gray-900">
    <div class="max-w-7xl mx-auto flex flex-col md:flex-row">
        <div class="dashboard-sidebar p-6 md:block hidden">
            <nav>
                <ul>
                    <li class="mb-4">
                        <a href="#" id="dashboard-link-sidebar-analytics" class="flex items-center text-gray-300 hover:text-blue-400 transition-colors duration-200">
                            <i class="fas fa-home text-lg"></i><span>Home</span>
                        </a>
                    </li>
                    <li class="mb-4">
                        <a href="#" id="analytics-link-sidebar-analytics" class="flex items-center text-blue-400 font-semibold hover:text-blue-200 transition-colors duration-200">
                            <i class="fas fa-chart-line text-lg"></i><span>Analytics</span>
                        </a>
                    </li>
                    <li class="mb-4">
                        <a href="#" id="accounts-link-sidebar-analytics" class="flex items-center text-gray-300 hover:text-blue-400 transition-colors duration-200">
                            <i class="fas fa-user-friends text-lg"></i><span>Accounts</span>
                        </a>
                    </li>
                    <li class="mb-4">
                        <a href="#banned-users-page-section" id="banned-users-link-sidebar-analytics" class="flex items-center text-gray-300 hover:text-red-400 transition-colors duration-200">
                            <i class="fas fa-ban text-lg"></i><span>Banned Users</span>
                        </a>
                    </li>
                    <li class="mb-4">
                        <a href="#" id="settings-link-sidebar-analytics" class="flex items-center text-gray-300 hover:text-blue-400 transition-colors duration-200">
                            <i class="fas fa-cog text-lg"></i><span>Settings</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>

        <div class="dashboard-content">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold text-gray-100">Your Instagram Analytics</h2>
                <div class="flex items-center space-x-3">
                    <select id="data-upload-selector-analytics" class="border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-gray-100">
                        <option value="">Select Data Upload</option>
                    </select>
                    <button id="upload-new-data-btn-analytics" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors duration-200 font-medium">
                        <i class="fas fa-upload mr-2"></i>Upload New Data
                    </button>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="metric-card">
                    <p class="label">Unfollowed You</p>
                    <p class="value flex items-center justify-center text-green-500">
                        <i class="fas fa-arrow-down mr-2"></i><span id="newFollowersCount">0</span>
                    </p>
                </div>
                <div class="metric-card">
                    <p class="label">New Followers</p>
                    <p class="value flex items-center justify-center text-red-500">
                        <i class="fas fa-arrow-up mr-2"></i><span id="unfollowedYouCount">0</span>
                    </p>
                </div>
            </div>
            <!-- List of Unfollowed Accounts -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg mb-8">
                <h3 class="text-xl font-bold text-gray-100 mb-4">Unfollowers</h3>
                <div id="new-followers-list" class="space-y-2">
                    <p class="text-gray-500 text-center">No unfollow data available for this period.</p>
                </div>
            </div>
            <!-- List of New Followers -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg mb-8">
                <h3 class="text-xl font-bold text-gray-100 mb-4">New Followers</h3>
                <div id="unfollowed-list" class="space-y-2">
                    <p class="text-gray-500 text-center">No new follower data available for this period.</p>
                </div>
            </div>
        </div>
    </div>
  </section>

  <!-- New Accounts Management Section -->
  <section id="accounts-section" class="hidden py-16 px-6 bg-gray-900">
    <div class="max-w-7xl mx-auto flex flex-col md:flex-row">
      <div class="dashboard-sidebar p-6 md:block hidden">
        <nav>
          <ul>
            <li class="mb-4">
              <a href="#" id="dashboard-link-sidebar-accounts" class="flex items-center text-gray-300 hover:text-blue-400 transition-colors duration-200">
                <i class="fas fa-home text-lg"></i><span>Home</span>
              </a>
            </li>
            <li class="mb-4">
              <a href="#" id="analytics-link-sidebar-accounts" class="flex items-center text-gray-300 hover:text-blue-400 transition-colors duration-200">
                <i class="fas fa-chart-line text-lg"></i><span>Analytics</span>
              </a>
            </li>
            <li class="mb-4">
              <a href="#" id="accounts-link-sidebar-accounts" class="flex items-center text-blue-400 font-semibold hover:text-blue-200 transition-colors duration-200">
                <i class="fas fa-user-friends text-lg"></i><span>Accounts</span>
              </a>
            </li>
            <li class="mb-4">
              <a href="#banned-users-page-section" id="banned-users-link-sidebar-accounts" class="flex items-center text-gray-300 hover:text-red-400 transition-colors duration-200">
                <i class="fas fa-ban text-lg"></i><span>Banned Users</span>
              </a>
            </li>
            <li class="mb-4">
              <a href="#" id="settings-link-sidebar-accounts" class="flex items-center text-gray-300 hover:text-blue-400 transition-colors duration-200">
                <i class="fas fa-cog text-lg"></i><span>Settings</span>
              </a>
            </li>
          </ul>
        </nav>
      </div>

      <div class="dashboard-content">
        <div class="flex justify-between items-center mb-8">
          <h2 class="text-3xl font-bold text-gray-100">Accounts Management</h2>
          <div class="flex items-center space-x-3">
            <!-- Data upload selector removed as per user request -->
            <button id="upload-new-data-btn-accounts" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors duration-200 font-medium">
              <i class="fas fa-upload mr-2"></i>Upload New Data
            </button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="metric-card bg-orange-800" id="accounts-to-remove-card">
            <p class="label">Accounts to Review</p>
            <p class="value" id="accounts-to-remove-count">0</p>
          </div>
          <div class="metric-card" id="total-accounts-removed-card">
            <p class="label">Total Accounts Removed</p>
            <p class="value" id="total-accounts-removed-count">0</p>
          </div>
          <div class="metric-card" id="approved-accounts-card">
            <p class="label">Approved Users</p>
            <p class="value" id="approved-accounts-count">0</p>
          </div>
          <div class="metric-card">
            <p class="label">Oldest Account to Remove</p>
            <p class="value" id="oldest-account-to-remove-age">N/A</p>
          </div>
        </div>

        <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
          <div class="flex justify-between items-center mb-6">
            <h3 id="accounts-list-title" class="text-xl font-bold text-gray-100">Accounts to Review</h3>
            <div class="flex items-center space-x-4">
              <input type="text" id="accounts-search-input" placeholder="Search for a specific account..." class="border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-gray-100" />
              <select id="accounts-sort-select" class="border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-gray-100">
                <option value="oldest">Oldest</option>
                <option value="newest">Newest</option>
                <option value="alpha-asc">Alphabetical (A-Z)</option>
                <option value="alpha-desc">Alphabetical (Z-A)</option>
              </select>
              <button class="text-gray-300 hover:text-blue-400"><i class="fas fa-download mr-2"></i>Download CSV</button>
            </div>
          </div>

          <div id="accounts-management-list" class="space-y-2">
            <p class="text-gray-500 text-center">No accounts to display. Upload your Instagram data.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- New Banned Users Page Section -->
  <section id="banned-users-page-section" class="hidden py-16 px-6 bg-gray-900">
    <div class="max-w-7xl mx-auto flex flex-col md:flex-row">
      <div class="dashboard-sidebar p-6 md:block hidden">
        <nav>
          <ul>
            <li class="mb-4">
              <a href="#" id="dashboard-link-sidebar-banned" class="flex items-center text-gray-300 hover:text-blue-400 transition-colors duration-200">
                <i class="fas fa-home text-lg"></i><span>Home</span>
              </a>
            </li>
            <li class="mb-4">
              <a href="#" id="analytics-link-sidebar-banned" class="flex items-center text-gray-300 hover:text-blue-400 transition-colors duration-200">
                <i class="fas fa-chart-line text-lg"></i><span>Analytics</span>
              </a>
            </li>
            <li class="mb-4">
              <a href="#" id="accounts-link-sidebar-banned" class="flex items-center text-gray-300 hover:text-blue-400 transition-colors duration-200">
                <i class="fas fa-user-friends text-lg"></i><span>Accounts</span>
              </a>
            </li>
            <li class="mb-4">
              <a href="#banned-users-page-section" id="banned-users-link-sidebar-banned" class="flex items-center text-red-400 font-semibold hover:text-red-200 transition-colors duration-200">
                <i class="fas fa-ban text-lg"></i><span>Banned Users</span>
              </a>
            </li>
            <li class="mb-4">
              <a href="#" id="settings-link-sidebar-banned" class="flex items-center text-gray-300 hover:text-blue-400 transition-colors duration-200">
                <i class="fas fa-cog text-lg"></i><span>Settings</span>
              </a>
            </li>
          </ul>
        </nav>
      </div>

      <div class="dashboard-content">
        <div class="flex justify-between items-center mb-8">
          <h2 class="text-3xl font-bold text-gray-100">Banned Users Management</h2>
          <div class="flex items-center space-x-3">
            <button id="add-banned-user-modal-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg shadow hover:bg-red-700 transition-colors duration-200 font-medium">
                <i class="fas fa-plus mr-2"></i>Add Banned Users
            </button>
          </div>
        </div>

        <div class="bg-gray-800 p-6 rounded-xl shadow-lg mb-8">
          <h3 class="text-xl font-bold text-gray-100 mb-4">Accounts Previously on Orange List</h3>
          <p class="text-gray-300 mb-4">These users were identified as not following you back within 1-7 days of your follow.</p>
          <div id="orange-list-users" class="space-y-2 max-h-60 overflow-y-auto border border-gray-600 rounded-lg p-2 bg-gray-700">
            <p class="text-gray-500 text-center">No orange list users found.</p>
          </div>
        </div>

        <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
          <h4 class="text-xl font-bold mb-3 text-gray-100">Check for Banned Users</h4>
          <p class="text-gray-300 mb-4">Upload a .txt or .html file or paste Instagram links/usernames to check against your *permanently* banned list.</p>
          <div class="flex flex-col gap-3 mb-4">
            <input type="file" id="banned-users-file-input" accept=".txt, .html" class="w-full text-gray-300 bg-gray-700 border border-gray-600 rounded-lg p-2 cursor-pointer" />
            <textarea id="banned-users-text-input" placeholder="Paste Instagram username links or usernames (one per line, or comma-separated)" rows="4" class="w-full border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-gray-100 resize-y"></textarea>
            <button id="check-banned-users-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors duration-200">
                <i class="fas fa-search mr-2"></i>Check
            </button>
          </div>
          <div id="banned-users-matches-display" class="bg-gray-700 p-4 rounded-lg border border-gray-600 text-left hidden">
            <p class="font-semibold text-gray-100 mb-2" id="matches-count-text"></p>
            <ul id="matches-list" class="list-disc list-inside text-gray-300 space-y-1"></ul>
          </div>
        </div>
      </div>
    </div>
  </section>


  <footer class="bg-gray-900 text-white py-8 px-6 text-center mt-auto">
    <div class="max-w-6xl mx-auto">
      <div class="flex flex-col md:flex-row justify-between items-center mb-6 space-y-4 md:space-y-0">
        <div class="text-xl font-bold">FollowBuddy</div>
        <nav class="flex space-x-6">
          <a href="#features" class="text-gray-300 hover:text-white transition-colors duration-200">Features</a>
          <a href="#upload" class="text-gray-300 hover:text-white transition-colors duration-200">Upload</a>
          <a href="#" class="text-gray-300 hover:text-white transition-colors duration-200">Privacy Policy</a>
          <a href="#" class="text-gray-300 hover:text-white transition-colors duration-200">Terms of Service</a>
        </nav>
        <div class="flex space-x-4">
          <a href="#" class="text-gray-300 hover:text-white transition-colors duration-200"><i class="fab fa-twitter"></i></a>
          <a href="#" class="text-gray-300 hover:text-white transition-colors duration-200"><i class="fab fa-facebook-f"></i></a>
          <a href="#" class="text-gray-300 hover:text-white transition-colors duration-200"><i class="fab fa-instagram"></i></a>
        </div>
      </div>
      <p class="text-gray-400 text-sm">&copy; 2025 FollowBudd. All rights reserved. Developed by Max Hydell.</p>
    </div>
  </footer>

  <div id="custom-alert-modal" class="modal">
    <div class="modal-content">
      <span class="close-button" id="close-alert-modal">&times;</span>
      <p id="alert-message" class="text-lg font-semibold text-gray-800"></p>
      <button id="alert-ok-btn" class="mt-6 bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors duration-200">OK</button>
    </div>
  </div>

  <div id="safe-users-modal" class="modal">
    <div class="modal-content">
      <span class="close-button" id="close-safe-users-modal">&times;</span>
      <h3 class="text-2xl font-bold mb-4 text-gray-100">Safe Users</h3>
      <p class="text-gray-300 mb-4">Add users here to exclude them from your "Not Following You Back" list.</p>
      <div class="flex flex-col gap-3 mb-4">
        <div class="flex">
            <input type="text" id="safe-user-input" placeholder="Enter single username" class="flex-grow border border-gray-600 rounded-l-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-gray-100" list="safe-user-suggestions" />
            <datalist id="safe-user-suggestions"></datalist>
            <button id="add-safe-user-btn" class="bg-blue-600 text-white px-4 py-2 rounded-r-lg shadow hover:bg-blue-700 transition-colors duration-200">Add</button>
        </div>
        <textarea id="bulk-safe-user-input" placeholder="Enter multiple usernames, separated by commas or new lines" rows="4" class="w-full border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-gray-100 resize-y"></textarea>
        <button id="add-bulk-safe-user-btn" class="bg-purple-600 text-white px-4 py-2 rounded-lg shadow hover:bg-purple-700 transition-colors duration-200">Add All</button>
      </div>
      <div id="safe-users-list" class="max-h-48 overflow-y-auto border border-gray-600 rounded-lg p-2 bg-gray-700">
        <p class="text-gray-500 text-center">No safe users added yet.</p>
      </div>
    </div>
  </div>

  <!-- New Banned Users Add Modal (for adding/removing from the permanent banned list) -->
  <div id="banned-users-add-modal" class="modal">
    <div class="modal-content">
      <span class="close-button" id="close-banned-users-add-modal">&times;</span>
      <h3 class="text-2xl font-bold mb-4 text-gray-100">Manage Banned Users List</h3>
      <p class="text-gray-300 mb-4">Add or remove users from your permanent banned list.</p>
      
      <div class="flex flex-col gap-3 mb-4">
        <div class="flex">
            <input type="text" id="banned-user-input" placeholder="Enter single username to ban" class="flex-grow border border-gray-600 rounded-l-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 bg-gray-700 text-gray-100" list="banned-user-suggestions" />
            <datalist id="banned-user-suggestions"></datalist>
            <button id="add-banned-user-btn" class="bg-red-600 text-white px-4 py-2 rounded-r-lg shadow hover:bg-red-700 transition-colors duration-200">Add</button>
        </div>
        <textarea id="bulk-banned-user-input" placeholder="Enter multiple usernames to ban, separated by commas or new lines" rows="4" class="w-full border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 bg-gray-700 text-gray-100 resize-y"></textarea>
        <button id="add-bulk-banned-user-btn" class="bg-red-800 text-white px-4 py-2 rounded-lg shadow hover:bg-red-900 transition-colors duration-200">Add All</button>
      </div>

      <div id="banned-users-list" class="max-h-48 overflow-y-auto border border-gray-600 rounded-lg p-2 bg-gray-700 mb-4">
        <p class="text-gray-500 text-center">No banned users added yet.</p>
      </div>
    </div>
  </div>
  <!-- End New Banned Users Add Modal -->
  <div id="approved-users-modal" class="modal">
    <div class="modal-content">
      <span class="close-button" id="close-approved-users-modal">&times;</span>
      <h3 class="text-xl font-bold mb-4 text-gray-100">Approved Users</h3>
      <div id="approved-users-list" class="space-y-2 max-h-80 overflow-y-auto custom-scroll">
        <p class="text-gray-500 text-center">Loading approved users...</p>
      </div>
    </div>
  </div>


  <!-- New Add Account Page Section (formerly a modal) -->
  <section id="add-account-page-section" class="hidden py-16 px-6 bg-gray-900">
    <div class="max-w-xl mx-auto bg-gray-800 p-8 rounded-xl shadow-lg text-center">
      <h3 class="text-3xl font-bold mb-4 text-gray-100">Add Account(s) I Follow</h3>
      <p class="text-gray-300 mb-6">Manually add Instagram usernames to your "Following" list. This will update your dashboard metrics by calling your new cloud function.</p>
      <div class="flex flex-col gap-4 mb-6">
        <input type="text" id="single-add-account-input" placeholder="Enter single username" class="w-full border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-gray-100" />
        <button id="add-single-account-btn" class="bg-blue-600 text-white px-6 py-3 rounded-lg shadow hover:bg-blue-700 transition-colors duration-200 font-medium flex items-center justify-center h-12">
            <span class="button-text">Add Single Account</span>
            <div class="button-spinner"></div>
        </button>
        <div class="border-t border-gray-700 my-4"></div>
        <textarea id="bulk-add-account-input" placeholder="Enter multiple usernames, separated by commas or new lines" rows="6" class="w-full border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-gray-100 resize-y"></textarea>
        <button id="add-bulk-accounts-btn" class="bg-purple-600 text-white px-6 py-3 rounded-lg shadow hover:bg-purple-700 transition-colors duration-200 font-medium flex items-center justify-center h-12">
            <span class="button-text">Add All Accounts</span>
            <div class="button-spinner"></div>
        </button>
      </div>
      <div id="added-accounts-preview" class="max-h-60 overflow-y-auto border border-gray-600 rounded-lg p-4 bg-gray-700">
        <p class="text-gray-500 text-center">Accounts added will appear here.</p>
      </div>
    </div>
  </section>
  <!-- End New Add Account Page Section -->



  <div id="upload-data-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" id="close-upload-data-modal">&times;</span>
        <h2 class="text-3xl font-bold mb-8 text-gray-100">Upload Your Instagram Data</h2>
        <div id="modal-initial-upload-area">
            <div id="modal-upload-area" class="upload-area p-12 rounded-lg flex flex-col items-center justify-center mb-8">
                <i class="fas fa-cloud-upload-alt text-6xl text-gray-500 mb-4"></i>
                <p class="text-gray-400 text-lg mb-4">Upload your Instagram ZIP or HTML files</p>
                <p class="text-gray-500 mb-6">Drag and drop your file here, or click to browse</p>
                <input type="file" id="modal-file-input" accept=".zip, .html" class="hidden" />
                <button id="modal-choose-file-btn" class="bg-blue-600 text-white px-6 py-3 rounded-lg shadow hover:bg-blue-700 transition-colors duration-200 flex items-center space-x-2">
                    <i class="fas fa-plus-circle"></i>
                    <span>Choose File</span>
                </button>
            </div>
        </div>
        <div class="bg-blue-900 p-6 rounded-lg text-left text-blue-200">
            <p class="font-semibold mb-2"><i class="fas fa-info-circle mr-2"></i>File Requirements:</p>
            <ul class="list-disc list-inside space-y-1">
                <li>ZIP or HTML files (.zip, .html)</li>
                <li>Maximum size: 200MB (though larger files are handled by the script if browser memory allows)</li>
            </ul>
        </div>
    </div>
  </div>

  <div id="auth-modal" class="modal">
    <div class="modal-content">
      <span class="close-button" id="close-auth-modal">&times;</span>
      <h3 class="text-2xl font-bold mb-4 text-gray-100">Account Access</h3>
      <p class="text-gray-300 mb-6">Login or create an account to save your data.</p>
      <input type="email" id="auth-email-input" placeholder="Email" class="w-full p-3 rounded-lg bg-gray-700 text-gray-100 border border-gray-600 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" />
      <input type="password" id="auth-password-input" placeholder="Password" class="w-full p-3 rounded-lg bg-gray-700 text-gray-100 border border-gray-600 mb-6 focus:outline-none focus:ring-2 focus:ring-blue-500" />
      <button id="auth-login-btn" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg shadow hover:bg-blue-700 transition-colors duration-200 font-medium mb-3">Login</button>
      <button id="auth-signup-btn" class="w-full bg-purple-600 text-white px-6 py-3 rounded-lg shadow hover:bg-purple-700 transition-colors duration-200 font-medium">Sign Up</button>
    </div>
  </div>

  <!-- New Modal for "People You Unfollowed" -->
  <div id="unfollowed-profiles-modal" class="modal">
    <div class="modal-content">
      <span class="close-button" id="close-unfollowed-profiles-modal">&times;</span>
      <h3 class="text-2xl font-bold mb-4 text-gray-100">People You Unfollowed</h3>
      <p class="text-gray-300 mb-4">This list shows accounts you have recently unfollowed, based on your Instagram data.</p>
      <div id="unfollowed-profiles-list" class="max-h-96 overflow-y-auto border border-gray-600 rounded-lg p-2 bg-gray-700">
        <p class="text-gray-500 text-center">No unfollowed profiles found.</p>
      </div>
    </div>
  </div>
<!-- Followers List Modal -->
<div id="followers-list-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" id="close-followers-list-modal">&times;</span>
        <h3 class="text-2xl font-bold mb-4">Your Followers</h3>
        <input type="text" id="followers-search-input" placeholder="Search followers..." class="w-full p-2 mb-4 rounded bg-gray-700 text-gray-100 border border-gray-600" />
        <div id="followers-list-container" class="max-h-80 overflow-y-auto custom-scrollbar text-left">
            <!-- Followers list items will be rendered here -->
            <p class="text-gray-500 text-center">Loading followers...</p>
        </div>
    </div>
</div>

<!-- Following List Modal -->
<div id="following-list-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" id="close-following-list-modal">&times;</span>
        <h3 class="text-2xl font-bold mb-4">People You Are Following</h3>
        <input type="text" id="following-search-input" placeholder="Search following..." class="w-full p-2 mb-4 rounded bg-gray-700 text-gray-100 border border-gray-600" />
        <div id="following-list-container" class="max-h-80 overflow-y-auto custom-scrollbar text-left">
            <!-- Following list items will be rendered here -->
            <p class="text-gray-500 text-center">Loading following...</p>
        </div>
    </div>
</div>

  <!-- Notification Container -->
  <div id="notification-container" class="notification"></div>


  <script type="module">
    // Firebase SDK imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, getDocs, onSnapshot, deleteDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
    // NEW: Import Firebase Functions SDK
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-functions.js";
    


    // Global Firebase instances and user data
    let appInstance;
    let authInstance;
    let dbInstance;
    let currentUserId = null;
    let currentFileData = null;
    let unsubscribeFromFirebase = null; // New: To manage our Firebase listener // Store processed data temporarily for the currently selected upload
    let allNonFollowers = []; // Store the filtered non-followers for display and search
    let originalNotFollowingBack = []; // Store the original non-followers before safe user filtering
    let safeUsers = []; // Store safe users
    let bannedUsers = []; // New: Store banned users (permanent list)
    let allUserUploadsMetadata = []; // Stores {id, timestamp, fileName, followersList, followingList} for all uploads
    let functionsInstance; // NEW: For Cloud Functions
    let addInstagramAccountCallable; // NEW: The callable function reference

    let followersListModal;
    let closeFollowersListModal;
    let followersListContainer;
    let followersSearchInput;

    let followingListModal;
    let closeFollowingListModal;
    let followingListContainer;
    let followingSearchInput;

    // New: Dashboard Metric Card elements (Add these global declarations)
    let followersCard;
    let followingCard;


    // New global variables for Accounts Management
    let accountsManuallyAddedForReview = []; // List of accounts manually added for review in accounts management
    let approvedAccountsList = []; // List of approved usernames
    let removedAccountsList = []; // List of removed usernames
    let manuallyUnfollowedList = []; // New: List of users manually unfollowed via the app
    let accountsToRemoveList = []; // Initialize accountsToRemoveList here

    let currentAccountsViewMode = 'toRemove'; // 'toRemove', 'approved', 'removed'

    // New global variable for manually added following accounts
    let manuallyAddedFollowing = [];

    // Use __app_id and __firebase_config from the environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
        apiKey: "AIzaSyAZbNfrDlMXFtmws_5tJnxcyViaHMMFr5g",
        authDomain: "followbuddy-5427d.firebaseapp.com",
        projectId: "followbuddy-5427d",
        storageBucket: "followbuddy-5427d.firebasestorage.app",
        messagingSenderId: "363452171593",
        appId: "1:363452171593:web:412e74ee7d956876228698",
        measurementId: "G-YQ2MEKT92B"
    };
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;


    // Custom Alert Function
    function showAlert(message, type = 'info') { // 'info', 'success', 'error'
        const modal = document.getElementById('custom-alert-modal');
        const alertMessage = document.getElementById('alert-message');
        const closeButton = document.getElementById('close-alert-modal');
        const okButton = document.getElementById('alert-ok-btn');
        const modalContent = modal.querySelector('.modal-content');

        // Reset classes
        modalContent.classList.remove('modal-success', 'modal-error', 'modal-info');
        
        // Apply type-specific styles
        if (type === 'success') {
            modalContent.classList.add('modal-success');
        } else if (type === 'error') {
            modalContent.classList.add('modal-error');
        } else { // default info
            modalContent.classList.add('modal-info');
        }

        alertMessage.textContent = message;
        modal.style.display = 'flex';

        const closeAlert = () => {
            modal.style.display = 'none';
        };

        closeButton.onclick = closeAlert;
        okButton.onclick = closeAlert;
        window.onclick = (event) => {
            if (event.target == modal) {
                closeAlert();
            }
        };
    }

    // New: Custom Notification Function (bottom right, disappears)
    function showNotification(message, type = 'success', duration = 2000) {
        const notificationContainer = document.getElementById('notification-container');
        notificationContainer.textContent = message;
        
        // Reset classes and apply type-specific styles
        notificationContainer.classList.remove('bg-green-500', 'bg-red-500', 'bg-blue-500');
        if (type === 'success') {
            notificationContainer.classList.add('bg-green-500');
        } else if (type === 'error') {
            notificationContainer.classList.add('bg-red-500');
        } else { // default info
            notificationContainer.classList.add('bg-blue-500');
        }

        notificationContainer.classList.add('show');

        setTimeout(() => {
            notificationContainer.classList.remove('show');
        }, duration);
    }


    // Function to open the new Upload Data Modal
    function openUploadDataModal() {
        uploadDataModal.style.display = 'flex';
        // Reset the modal's internal state to initial upload area
        document.getElementById('modal-initial-upload-area').classList.remove('hidden');
        // If there was a success state inside the modal, hide it. (Not implemented yet, but good to plan)
    }

    // Function to close the new Upload Data Modal
    function closeUploadDataModalFunc() {
        uploadDataModal.style.display = 'none';
        modalFileInput.value = ''; // Clear the file input in modal
    }

    // Declare elements as `let` so they can be assigned inside window.onload
    let loginBtnNav;
    let logoutBtnNav;
    let loginBtnMobile;
    let logoutBtnMobile;
    let accessPremiumBtn;
    let initialUploadArea;
    let uploadSuccessState;
    let uploadedFileName;
    let uploadedFileSize;
    let removeFileBtn;
    let findNonFollowersBtn;

    let uploadArea;
    let fileInput;
    let chooseFileBtn;

    let uploadDataModal;
    let closeUploadDataModal;
    let modalUploadArea;
    let modalFileInput;
    let modalChooseFileBtn;

    let mobileMenuButton;
    let mobileMenu;
    let closeMobileMenu;
    let dashboardSection;
    let heroSection;
    let uploadSection;
    let featuresSection;
    let dashboardNavLink;
    let dashboardNavLinkMobile;
    let nonFollowersList;
    let noDataMessage;
    let followingCountElem;
    let followersCountElem;
    let newFollowersCountElem;
    let unfollowedYouCountElem;
    let notFollowingBackFilteredCountElem;
    let notFollowingBackTotalCountElem;
    let youDontFollowBackCountElem;
    let analyticsSection; // New: Analytics Section
    let sortSelect; // New: Sort Selector

    let uploadNewDataBtn;
    let uploadNewDataBtnAnalytics; // New: Upload data button for analytics section
    let searchInput;
    let timeFilterSelect;
    let userIdDisplay;
    let analyticsLinkDashboard; // Analytics link in dashboard sidebar
    let dashboardLinkSidebar; // Home link in dashboard sidebar
    let accountsLinkDashboard; // Accounts link in dashboard sidebar
    let settingsLinkDashboard; // Settings link in dashboard sidebar
    let bannedUsersLinkSidebarDashboard; // New: Banned Users link in dashboard sidebar

    let analyticsLinkAnalytics; // Analytics link in analytics sidebar
    let dashboardLinkSidebarAnalytics; // Home link in analytics sidebar
    let accountsLinkAnalytics; // Accounts link in analytics sidebar
    let settingsLinkAnalytics; // Settings link in analytics sidebar
    let bannedUsersLinkSidebarAnalytics; // New: Banned Users link in analytics sidebar

    // New Accounts Management elements
    let accountsSection;
    let dashboardLinkSidebarAccounts;
    let analyticsLinkSidebarAccounts;
    let accountsLinkSidebarAccounts;
    let settingsLinkSidebarAccounts;
    let bannedUsersLinkSidebarAccounts; // New: Banned Users link in accounts sidebar
    // let dataUploadSelectorAccounts; // Removed as per user request
    let uploadNewDataBtnAccounts;
    let accountsToRemoveCard;
    let accountsToRemoveCount;
    let totalAccountsRemovedCard;
    let totalAccountsRemovedCount;
    let approvedAccountsCard;
    let approvedAccountsCount;
    let oldestAccountToRemoveAge;
    let accountsListTitle;
    let accountsSearchInput;
    let accountsSortSelect;
    let accountsManagementList;
    let approvedUsersModal;
    let closeApprovedUsersModal;
    let approvedUsersListElem;

    // New Banned Users Page elements
    let bannedUsersPageSection;
    let dashboardLinkSidebarBanned;
    let analyticsLinkSidebarBanned;
    let accountsLinkSidebarBanned;
    let settingsLinkSidebarBanned;
    let bannedUsersLinkSidebarBanned;
    let addBannedUserModalBtn; // Button to open the add banned users modal
    let orangeListUsersElem; // Element to display orange list users

    // Existing Banned Users Modal elements (now for adding/removing from permanent list)
    let bannedUsersAddModal; // Renamed from bannedUsersModal
    let closeBannedUsersAddModal; // Renamed from closeBannedUsersModal
    let bannedUserInput;
    let bannedUserSuggestionsDatalist;
    let addBannedUserBtn;
    let bulkBannedUserInput;
    let addBulkBannedUserBtn;
    let bannedUsersListElem;

    // Existing Banned Users Check elements (now on the new page)
    let bannedUsersFileInput;
    let bannedUsersTextInput;
    let checkBannedUsersBtn;
    let bannedUsersMatchesDisplay;
    let matchesCountText;
    let matchesList;

    let safeUsersBtn;
    let safeUsersModal;
    let closeSafeUsersModal;
    let safeUserInput;
    let safeUserSuggestionsDatalist;
    let addSafeUserBtn;
    let bulkSafeUserInput;
    let addBulkSafeUserBtn;
    let safeUsersListElem;
    let unfollowedListElem; // New: Unfollowed list element
    let newFollowersListElem; // New: New Followers list element

    let authModal;
    let closeAuthModal;
    let authEmailInput;
    let authPasswordInput;
    let authLoginBtn;
    let authSignupBtn;

    let dataUploadSelectorDashboard; // New: Data upload selector for dashboard
    let dataUploadSelectorAnalytics; // New: Data upload selector for analytics

    // New button elements
    let openGreenUsersBtn;
    let openOrangeUsersBtn;
    let openRedUsersBtn;

    // New Add Account elements
    let addAccountNavLink;
    let addAccountNavLinkMobile;
    let addAccountPageSection; // Renamed from addAccountModal
    // let closeAddAccountModal; // This will no longer close a modal, but can be repurposed if needed
    let singleAddAccountInput;
    let addSingleAccountBtn;
    let bulkAddAccountInput;
    let addBulkAccountsBtn;
    let addedAccountsPreview;

    // New: Elements for "People You Unfollowed" modal
    let youDontFollowBackCard;
    let unfollowedProfilesModal;
    let closeUnfollowedProfilesModal;
    let unfollowedProfilesListElem;


    // Function to initialize Firebase
    async function initializeFirebaseApp() {
        console.log("Firebase Config being used:", firebaseConfig);

        if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "" || firebaseConfig.apiKey === "YOUR_FIREBASE_API_KEY") {
            console.error("Firebase API Key is missing or empty in the configuration. Using anonymous sign-in.");
            // Do not show an error alert here, as anonymous sign-in is a valid fallback.
        }

        try {
            appInstance = initializeApp(firebaseConfig);
            authInstance = getAuth(appInstance);
            dbInstance = getFirestore(appInstance);
            // NEW: Initialize Functions and the callable function reference
            functionsInstance = getFunctions(appInstance, 'us-central1'); // Specify region if not default
            addInstagramAccountCallable = httpsCallable(functionsInstance, 'addinstagramaccount');

            onAuthStateChanged(authInstance, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    userIdDisplay.textContent = currentUserId;
                    console.log('User logged in:', currentUserId);
                    await loadAllUserUploads(); // Load all uploads for the selector
                    await loadLatestData(); // Load the latest data by default

                    loginBtnNav.style.display = 'none';
                    loginBtnMobile.style.display = 'none';
                    logoutBtnNav.style.display = 'block';
                    logoutBtnMobile.style.display = 'block';
                    accessPremiumBtn.textContent = 'Go to Dashboard';
                    accessPremiumBtn.onclick = () => {
                        showDashboard();
                    };
                    
                } else {
                    // Sign in anonymously if no user is logged in and no initial token is provided
                    if (initialAuthToken) {
                        await signInWithCustomToken(authInstance, initialAuthToken);
                    } else {
                        await signInAnonymously(authInstance);
                    }
                    currentUserId = authInstance.currentUser?.uid || crypto.randomUUID(); // Use actual UID if signed in, else random
                    userIdDisplay.textContent = currentUserId;
                    console.log('User not logged in, using ID:', currentUserId);


                    loginBtnNav.style.display = 'block';
                    loginBtnMobile.style.display = 'block';
                    logoutBtnNav.style.display = 'none';
                    logoutBtnMobile.style.display = 'none';
                    accessPremiumBtn.textContent = 'Access Premium';
                    accessPremiumBtn.onclick = handleLogin;
                    showLandingPage();
                    currentFileData = null;
                    allNonFollowers = [];
                    originalNotFollowingBack = [];
                    safeUsers = [];
                    bannedUsers = []; // Reset banned users on logout
                    allUserUploadsMetadata = [];
                    accountsManuallyAddedForReview = []; // Reset accounts management list
                    approvedAccountsList = [];
                    removedAccountsList = [];
                    manuallyUnfollowedList = []; // Reset manually unfollowed list
                    accountsToRemoveList = []; // Reset accountsToRemoveList
                    manuallyAddedFollowing = []; // Reset manually added following
                    updateDashboardMetrics(0, 0, 0, 0, 0);
                    // Reset analytics metrics and unfollowed/new followers lists
                    updateAnalyticsMetrics(0, 0, [], []); 
                    updateAccountsManagementMetrics(); // Reset accounts management metrics
                    populateUploadSelectors(); // Clear selectors
                }
            });

            return true;
        } catch (error) {
            console.error('Firebase initialization or authentication failed:', error);
            showAlert('Failed to initialize Firebase. Some features may not work. Error: ' + error.message, 'error');
            return false;
        }
    }

    // Load all user uploads metadata for the dropdowns
    async function loadAllUserUploads() {
        if (!currentUserId || !dbInstance) {
            allUserUploadsMetadata = [];
            populateUploadSelectors();
            return;
        }
        try {
            const uploadsRef = collection(dbInstance, `artifacts/${appId}/users/${currentUserId}/userUploads`);
            const q = query(uploadsRef, orderBy('timestamp', 'desc')); // Order by newest first
            const querySnapshot = await getDocs(q);
            allUserUploadsMetadata = querySnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            populateUploadSelectors();
        } catch (error) {
            console.error('Error loading user uploads metadata:', error);
            showAlert('Failed to load historical data uploads.', 'error');
        }
    }

    // Populate the data upload selectors
    function populateUploadSelectors() {
        const selectors = [dataUploadSelectorDashboard, dataUploadSelectorAnalytics]; // Accounts selector removed
        selectors.forEach(selector => {
            selector.innerHTML = '<option value="">Select Data Upload</option>'; // Clear and add default
            allUserUploadsMetadata.forEach(upload => {
                const date = new Date(upload.timestamp * 1000); // Convert seconds to milliseconds
                const option = document.createElement('option');
                option.value = upload.id;
                // Display only date and time
                option.textContent = date.toLocaleString();
                selector.appendChild(option);
            });
            // Select the latest upload if available
            if (allUserUploadsMetadata.length > 0 && currentFileData) {
                selector.value = currentFileData.id;
            } else {
                selector.value = ""; // No selection
            }
        });

        // Add delete buttons to the selectors
        addDeleteButtonsToUploadSelectors();
    }

    // New: Add delete buttons to upload selectors
    function addDeleteButtonsToUploadSelectors() {
        const selectors = [dataUploadSelectorDashboard, dataUploadSelectorAnalytics];
        selectors.forEach(selector => {
            // Remove existing delete buttons first to prevent duplicates
            const existingDeleteBtn = document.getElementById(`delete-current-upload-btn-${selector.id}`);
            if (existingDeleteBtn) {
                existingDeleteBtn.remove();
            }

            const deleteButton = document.createElement('button');
            deleteButton.id = `delete-current-upload-btn-${selector.id}`;
            deleteButton.innerHTML = '<i class="fas fa-trash-alt text-red-500 hover:text-red-700"></i>';
            deleteButton.className = 'ml-2 px-3 py-2 rounded-lg bg-gray-700 text-gray-100 shadow hover:bg-gray-600 transition-colors duration-200';
            deleteButton.title = 'Delete currently selected upload';
            selector.parentNode.insertBefore(deleteButton, selector.nextSibling);

            deleteButton.onclick = () => {
                const selectedUploadId = selector.value;
                if (selectedUploadId) {
                    deleteUpload(selectedUploadId);
                } else {
                    showNotification('No upload selected to delete.', 'info');
                }
            };
        });
    }


    // New: Function to delete an upload
    async function deleteUpload(uploadId) {
        if (!currentUserId || !dbInstance || !uploadId) {
            showNotification('Cannot delete: No user or upload ID.', 'error');
            return;
        }

        // Confirmation (using custom alert for now, can be a custom modal later)
        showAlert('Are you sure you want to delete this upload and all its associated data? This action cannot be undone.', 'error');
        document.getElementById('alert-ok-btn').onclick = async () => {
            try {
                const uploadDocRef = doc(dbInstance, `artifacts/${appId}/users/${currentUserId}/userUploads`, uploadId);
                await setDoc(uploadDocRef, {}); // Clear the document
                console.log(`Upload ${uploadId} deleted from Firestore.`);
                showNotification('Upload deleted successfully!', 'success');

                await loadAllUserUploads(); // Reload metadata to update dropdowns
                
                // If the deleted upload was the currently selected one, load the new latest or reset
                if (currentFileData && currentFileData.id === uploadId) {
                    currentFileData = null; // Clear current data
                    await loadLatestData(); // Load the new latest or reset UI
                } else {
                    // If a different upload was deleted, just ensure UI is updated
                    populateUploadSelectors();
                    // Re-render current dashboard/analytics if needed
                    if (dashboardSection.classList.contains('hidden') === false) {
                        applyFiltersAndRenderAccounts();
                    } else if (analyticsSection.classList.contains('hidden') === false) {
                        findAndLoadBestAnalyticsData();
                    } else if (accountsSection.classList.contains('hidden') === false) {
                        applyAccountsManagementFiltersAndRender();
                    }
                }
            } catch (error) {
                console.error('Error deleting upload:', error);
                showAlert('Failed to delete upload. Error: ' + error.message, 'error');
            }
            document.getElementById('custom-alert-modal').style.display = 'none'; // Close alert
        };
        // If user clicks close/cancel on the alert, do nothing
        document.getElementById('close-alert-modal').onclick = () => {
            document.getElementById('custom-alert-modal').style.display = 'none';
        };
        window.onclick = (event) => {
            if (event.target == document.getElementById('custom-alert-modal')) {
                document.getElementById('custom-alert-modal').style.display = 'none';
            }
        };
    }


// Line 528: Replace the entire existing loadDataForUpload function
async function loadDataForUpload(uploadId) {
    if (!currentUserId || !dbInstance || !uploadId) {
        console.log("No upload ID provided or user not authenticated. Resetting UI.");
        currentFileData = null;
        allNonFollowers = [];
        originalNotFollowingBack = [];
        safeUsers = [];
        bannedUsers = []; // Reset banned users on data load
        accountsManuallyAddedForReview = []; // Reset accounts management list
        approvedAccountsList = [];
        removedAccountsList = [];
        manuallyUnfollowedList = []; // Reset manually unfollowed list
        accountsToRemoveList = []; // Initialize accountsToRemoveList
        manuallyAddedFollowing = []; // Reset manually added following
        bannedUsers = currentFileData.bannedUsers || []; // New: Load banned users
        updateDashboardMetrics(0, 0, 0, 0, 0);
        updateAnalyticsMetrics(0, 0, [], []); // Reset analytics metrics and lists
        updateAccountsManagementMetrics(); // Reset accounts management metrics
        renderAccounts([]); // Dashboard non-followers
        renderAccountsToRemove([]); // Accounts management list
        renderOrangeListUsers([]); // New: Clear orange list
        renderUnfollowedProfilesList([]); // Clear unfollowed profiles list
        return;
    }

    // New: Unsubscribe from previous listener if it exists
    if (unsubscribeFromFirebase) {
        unsubscribeFromFirebase();
        console.log("Unsubscribed from previous Firebase listener.");
    }

    try {
        const uploadDocRef = doc(dbInstance, `artifacts/default-app-id/users/${currentUserId}/userUploads`, uploadId);

        // New: Set up a real-time listener using onSnapshot
        unsubscribeFromFirebase = onSnapshot(uploadDocRef, async (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                currentFileData = { id: docSnap.id, ...data }; // Store the ID
                originalNotFollowingBack = currentFileData.originalNotFollowingBack || [];
                safeUsers = currentFileData.safeUsers || []; // Ensure safeUsers is loaded
                bannedUsers = currentFileData.bannedUsers || []; // New: Load banned users
                manuallyAddedFollowing = currentFileData.manuallyAddedFollowing || []; // Load manually added following
                accountsManuallyAddedForReview = currentFileData.accountsManuallyAddedForReview || []; // Load manually added for review
                approvedAccountsList = currentFileData.approvedAccounts || [];
                console.log("DEBUG: approvedAccountsList loaded from Firestore:", approvedAccountsList); // Added for verification
                removedAccountsList = currentFileData.removedAccounts || [];
                manuallyUnfollowedList = currentFileData.manuallyUnfollowedList || []; // Load manually unfollowed list
                accountsToRemoveList = []; // Initialize accountsToRemoveList here before use

                // Filter notFollowingBack based on current safeUsers
                allNonFollowers = originalNotFollowingBack.filter(account => !safeUsers.includes(account.username));

                // Accounts to Review logic: accounts manually added for review, that are NOT approved, NOT removed, AND NOT in the current (original + manually added - manually unfollowed) following list
                const combinedFollowingSet = new Set(currentFileData.followingList); // Base from uploaded file
                manuallyAddedFollowing.forEach(user => combinedFollowingSet.add(user)); // Add manually added
                manuallyUnfollowedList.forEach(user => combinedFollowingSet.delete(user)); // Remove manually unfollowed

                accountsToRemoveList = accountsManuallyAddedForReview.filter(account =>
                    !approvedAccountsList.includes(account.username) &&
                    !removedAccountsList.includes(account.username)
                );
                // Sort by oldest to newest by default for this list
                accountsToRemoveList.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));


                // Find the previous upload for analytics calculation
                const currentIndex = allUserUploadsMetadata.findIndex(upload => upload.id === uploadId);
                let unfollowedYou = 0; // This is actually "lost followers"
                let newFollowers = 0; // This is actually "gained followers"
                let unfollowedAccounts = []; // Accounts that unfollowed you (lost followers)
                let newFollowerAccounts = []; // Accounts that newly followed you (gained followers)

                // Only calculate analytics if there is a previous upload to compare against
                if (currentIndex < allUserUploadsMetadata.length - 1) { // Check if there's an older upload
                    const previousUploadMetadata = allUserUploadsMetadata[currentIndex + 1]; // This is the older upload
                    const previousUploadDocRef = doc(dbInstance, `artifacts/${appId}/users/${currentUserId}/userUploads`, previousUploadMetadata.id);
                    const prevDocSnap = await getDoc(previousUploadDocRef); // Still use getDoc for historical data

                    if (prevDocSnap.exists()) {
                        const prevData = prevDocSnap.data();
                        const currentFollowersSet = new Set(currentFileData.followersList);
                        const previousFollowersSet = new Set(prevData.followersList);

                        // Calculate unfollowed (lost followers)
                        unfollowedAccounts = Array.from(previousFollowersSet).filter(
                            follower => !currentFollowersSet.has(follower)
                        );
                        unfollowedYou = unfollowedAccounts.length;

                        // Calculate new followers (gained followers)
                        newFollowerAccounts = Array.from(currentFollowersSet).filter(
                            follower => !previousFollowersSet.has(follower)
                        );
                        newFollowers = newFollowerAccounts.length;
                    }
                }
                console.log(`Analytics for upload ${uploadId}: Unfollowed (lost followers): ${unfollowedYou}, New Followers (gained followers): ${newFollowers}`);

                // Calculate current total following including manual additions and removals
                const effectiveFollowingCount = (currentFileData.followingList || []).length + manuallyAddedFollowing.length - manuallyUnfollowedList.length;

                updateDashboardMetrics(
                    effectiveFollowingCount,
                    currentFileData.totalFollowers,
                    allNonFollowers.length,
                    originalNotFollowingBack.length,
                    (currentFileData.recentlyUnfollowedProfiles || []).length // Use the length of this list for the count
                );
                // Correctly pass newFollowers (gained) and unfollowedYou (lost) to their respective elements
                // The user requested to swap the display, so:
                // "New Followers" label displays `unfollowedYou` (lost followers)
                // "Unfollowed You" label displays `newFollowers` (gained followers)
                updateAnalyticsMetrics(unfollowedYou, newFollowers, unfollowedAccounts, newFollowerAccounts);
                updateAccountsManagementMetrics(); // Update new metrics for accounts management
                renderAccounts(allNonFollowers); // Render dashboard non-followers
                applyAccountsManagementFiltersAndRender(); // Render accounts management list
                renderOrangeListUsers(originalNotFollowingBack); // New: Render orange list users
                renderUnfollowedProfilesList(currentFileData.recentlyUnfollowedProfiles || []); // Render unfollowed profiles list
            } else {
                console.log('No data found for the selected upload ID:', uploadId);
                showAlert('No data found for the selected upload. Please try another or upload new data.', 'info');
                currentFileData = null;
                allNonFollowers = [];
                originalNotFollowingBack = [];
                safeUsers = [];
                bannedUsers = []; // Reset banned users
                accountsManuallyAddedForReview = []; // Reset accounts management list
                approvedAccountsList = [];
                removedAccountsList = [];
                manuallyUnfollowedList = []; // Reset manually unfollowed list
                accountsToRemoveList = []; // Initialize accountsToRemoveList
                manuallyAddedFollowing = []; // Reset manually added following
                updateDashboardMetrics(0, 0, 0, 0, 0);
                updateAnalyticsMetrics(0, 0, [], []);
                updateAccountsManagementMetrics();
                renderAccounts([]);
                renderAccountsToRemove([]);
                renderOrangeListUsers([]); // New: Clear orange list
                renderUnfollowedProfilesList([]); // Clear unfollowed profiles list
            }
        }, (error) => {
            console.error('Error listening to document:', error);
            showAlert('Failed to load data for the selected upload. Error: ' + error.message, 'error');
        });
    } catch (error) {
        console.error('Error setting up listener for upload:', error);
        showAlert('Failed to set up real-time data listener. Error: ' + error.message, 'error');
    }
}
    // Load the latest data by default when user logs in or app starts
    async function loadLatestData() {
        if (allUserUploadsMetadata.length > 0) {
            const latestUploadId = allUserUploadsMetadata[0].id; // First item is latest due to orderBy('desc')
            await loadDataForUpload(latestUploadId);
            // Set the dropdowns to the latest upload
            dataUploadSelectorDashboard.value = latestUploadId;
            dataUploadSelectorAnalytics.value = latestUploadId;
        } else {
            console.log('No uploads found for the user.');
            currentFileData = null;
            allNonFollowers = [];
            originalNotFollowingBack = [];
            safeUsers = [];
            bannedUsers = []; // Reset banned users
            accountsManuallyAddedForReview = []; // Reset accounts management list
            approvedAccountsList = [];
            removedAccountsList = [];
            manuallyUnfollowedList = []; // Reset manually unfollowed list
            accountsToRemoveList = []; // Initialize accountsToRemoveList
            manuallyAddedFollowing = []; // Reset manually added following
            updateDashboardMetrics(0, 0, 0, 0, 0);
            updateAnalyticsMetrics(0, 0, [], []);
            updateAccountsManagementMetrics();
            renderAccounts([]);
            renderAccountsToRemove([]);
            renderOrangeListUsers([]); // New: Clear orange list
            renderUnfollowedProfilesList([]); // Clear unfollowed profiles list
        }
    }


    // Function to render accounts (non-followers)
    function renderAccounts(accountsToRender) {
        nonFollowersList.innerHTML = ''; // Clear existing list
        if (accountsToRender.length === 0) {
            nonFollowersList.innerHTML = '<p id="no-data-message" class="text-gray-500 text-center">Upload your Instagram data to see who isn\'t following you back!</p>';
            return;
        }
        accountsToRender.forEach(account => {
            const timeInfo = account.timestamp ? formatTimeDifference(account.timestamp) : { text: 'N/A', color: 'text-gray-500' };
            const div = document.createElement('div');
            div.className = 'account-list-item';
            div.innerHTML = `
                <a href="https://www.instagram.com/${account.username}/" target="_blank" rel="noopener noreferrer" class="font-medium text-blue-400 hover:underline">
                    ${account.username}
                </a>
                <div class="flex items-center space-x-2">
                    <span class="time-col ${timeInfo.color}">${timeInfo.text}</span>
                    <button data-username="${account.username}" class="safe-user-dashboard-btn text-green-400 hover:text-green-500 transition-colors" title="Add to Safe List">
                        <i class="fas fa-user-plus"></i>
                    </button>
                    <button data-username="${account.username}" class="remove-from-following-dashboard-btn text-red-400 hover:text-red-500 transition-colors" title="Remove as Following">
                        <i class="fas fa-user-minus"></i>
                    </button>
                </div>
            `;
            nonFollowersList.appendChild(div);
        });

        // Add event listeners for new dashboard buttons
        document.querySelectorAll('.safe-user-dashboard-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const username = e.currentTarget.dataset.username;
                handleSafeUserFromDashboard(username);
            });
        });
        document.querySelectorAll('.remove-from-following-dashboard-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const username = e.currentTarget.dataset.username;
                handleRemoveFromFollowingFromDashboard(username);
            });
        });
    }

    // Function to render unfollowed accounts list (these are people who unfollowed you)
    function renderUnfollowedAccountsList(accounts) {
        unfollowedListElem.innerHTML = '';
        if (accounts.length === 0) {
            unfollowedListElem.innerHTML = '<p class="text-gray-500 text-center">No unfollow data available for this period.</p>';
            return;
        }
        accounts.forEach(username => {
            const div = document.createElement('div');
            div.className = 'account-list-item';
            div.innerHTML = `
                <a href="https://www.instagram.com/${username}/" target="_blank" rel="noopener noreferrer" class="font-medium text-red-400 hover:underline">
                    ${username}
                </a>
            `;
            unfollowedListElem.appendChild(div);
        });
    }

    // Function to render new followers accounts list (these are people who newly followed you)
    function renderNewFollowersList(accounts) {
        newFollowersListElem.innerHTML = '';
        if (accounts.length === 0) {
            newFollowersListElem.innerHTML = '<p class="text-gray-500 text-center">No new follower data available for this period.</p>';
            return;
        }
        accounts.forEach(username => {
            const div = document.createElement('div');
            div.className = 'account-list-item';
            div.innerHTML = `
                <a href="https://www.instagram.com/${username}/" target="_blank" rel="noopener noreferrer" class="font-medium text-green-400 hover:underline">
                    ${username}
                </a>
            `;
            newFollowersListElem.appendChild(div);
        });
    }

    // New: Function to render unfollowed profiles (from recently_unfollowed_profiles.json)
    function renderUnfollowedProfilesList(profiles) {
        unfollowedProfilesListElem.innerHTML = '';
        if (!profiles || profiles.length === 0) {
            unfollowedProfilesListElem.innerHTML = '<p class="text-gray-500 text-center">No unfollowed profiles found.</p>';
            return;
        }

        profiles.forEach(profile => {
            const username = profile.string_list_data[0].value;
            const timestamp = profile.string_list_data[0].timestamp;
            const date = new Date(timestamp * 1000); // Convert seconds to milliseconds
            const formattedDate = date.toLocaleString();

            const div = document.createElement('div');
            div.className = 'flex justify-between items-center py-2 px-3 border-b border-gray-600 last:border-b-0 text-gray-200';
            div.innerHTML = `
                <a href="https://www.instagram.com/${username}/" target="_blank" rel="noopener noreferrer" class="font-medium text-blue-400 hover:underline">
                    ${username}
                </a>
                <span class="text-gray-400 text-sm">${formattedDate}</span>
            `;
            unfollowedProfilesListElem.appendChild(div);
        });
    }

    // Function to render users on the "Orange List" for the Banned Users Page
    function renderOrangeListUsers(allNonFollowersData) {
        orangeListUsersElem.innerHTML = '';
        if (!allNonFollowersData || allNonFollowersData.length === 0) {
            orangeListUsersElem.innerHTML = '<p class="text-gray-500 text-center">No orange list users found (upload data to see them).</p>';
            return;
        }

        const orangeUsers = allNonFollowersData.filter(account => {
            if (!account.timestamp) return false;
            const timeInfo = formatTimeDifference(account.timestamp);
            return timeInfo.category === 'orange';
        });

        if (orangeUsers.length === 0) {
            orangeListUsersElem.innerHTML = '<p class="text-gray-500 text-center">No users currently in the orange list.</p>';
            return;
        }

        orangeUsers.forEach(account => {
            const timeInfo = formatTimeDifference(account.timestamp);
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center py-2 px-3 border-b border-gray-600 last:border-b-0 text-gray-200';
            div.innerHTML = `
                <a href="https://www.instagram.com/${account.username}/" target="_blank" rel="noopener noreferrer" class="font-medium text-orange-400 hover:underline">
                    ${account.username}
                </a>
                <span class="${timeInfo.color}">${timeInfo.text}</span>
            `;
            orangeListUsersElem.appendChild(div);
        });
    }

    // Function to format time difference for display
    function formatTimeDifference(timestamp) {
        // Instagram timestamps are in seconds (UTC). Date.now() is in milliseconds (UTC).
        const now = Date.now(); // Current time in milliseconds
        const diffMs = now - (timestamp * 1000); // Difference in milliseconds

        if (diffMs < 0) {
            return { text: 'Future follow?', color: 'text-gray-500', category: 'unknown' };
        }

        const seconds = Math.floor(diffMs / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);
        const months = Math.floor(days / 30.44); // Average days in a month
        const years = Math.floor(days / 365.25); // Average days in a year

        let text = '';
        let color = 'text-gray-500'; // Default color
        let category = 'unknown';

        if (years > 0) {
            text = `${years} Year${years > 1 ? 's' : ''} ago`;
        } else if (months > 0) {
            text = `${months} Month${months > 1 ? 's' : ''} ago`;
        } else if (days > 0) {
            text = `${days} Day${days > 1 ? 's' : ''} ago`;
        } else if (hours > 0) {
            text = `${hours} Hour${hours > 1 ? 's' : ''} ago`;
        } else if (minutes > 0) {
            text = `${minutes} Min${minutes > 1 ? 's' : ''} ago`;
        } else {
            text = `${seconds} Sec${seconds > 1 ? 's' : ''} ago`;
        }

        // Color coding based on recency
        if (diffMs <= 24 * 60 * 60 * 1000) { // Within 24 hours
            color = 'text-green-500';
            category = 'green';
        } else if (diffMs > 24 * 60 * 60 * 1000 && diffMs <= 7 * 24 * 60 * 60 * 1000) { // 1 day to 7 days
            color = 'text-orange-500';
            category = 'orange';
        } else { // Older than 7 days
            color = 'text-red-500';
            category = 'red';
        }

        return { text, color, category };
    }


    // Function to update dashboard metrics
    function updateDashboardMetrics(following, followers, filteredNotFollowingBack, totalNotFollowingBack, youDontFollowBack) {
        // Update basic follower/following counts
        followersCountElem.textContent = followers;
        followingCountElem.textContent = following;
        
        // Update combined 'Not Following You Back' metric
        notFollowingBackFilteredCountElem.textContent = filteredNotFollowingBack;
        notFollowingBackTotalCountElem.textContent = `/ ${totalNotFollowingBack}`;
        
        // Update 'People You Unfollowed' metric (from recently_unfollowed_profiles)
        youDontFollowBackCountElem.textContent = youDontFollowBack;
    }


// --- INSERT NEW MODAL-RELATED FUNCTIONS BELOW THIS LINE ---

// New: Function to render a generic list of accounts inside a modal
function renderAccountList(containerElement, accountsArray, searchTerm = '') {
    containerElement.innerHTML = ''; // Clear existing list
    const filteredAccounts = accountsArray.filter(account =>
        account.toLowerCase().includes(searchTerm.toLowerCase())
    ).sort((a, b) => a.localeCompare(b)); // Sort alphabetically

    if (filteredAccounts.length === 0) {
        containerElement.innerHTML = `<p class="text-gray-500 text-center">${searchTerm ? 'No matching profiles found.' : 'No data available.'}</p>`;
        return;
    }

    filteredAccounts.forEach(username => {
        const div = document.createElement('div');
        div.className = 'account-list-item'; // Reuse existing styling
        div.innerHTML = `
            <a href="https://www.instagram.com/${username}/" target="_blank" rel="noopener noreferrer" class="font-medium text-blue-400 hover:underline">
                ${username}
            </a>
        `;
        containerElement.appendChild(div);
    });
}

// New: Open Followers List Modal
function openFollowersListModal() {
    if (!currentFileData || !currentFileData.followersList) {
        showAlert('Followers data not available. Please upload your data.', 'info');
        return;
    }
    followersListModal.style.display = 'flex';
    renderAccountList(followersListContainer, currentFileData.followersList);
    followersSearchInput.value = ''; // Clear search input
    followersSearchInput.focus();
}

// New: Close Followers List Modal
function closeFollowersListModalFunc() {
    followersListModal.style.display = 'none';
}

// New: Open Following List Modal
function openFollowingListModal() {
    if (!currentFileData || !currentFileData.followingList) {
        showAlert('Following data not available. Please upload your data.', 'info');
        return;
    }
    // Combine original following list with manually added and remove manually unfollowed
    const effectiveFollowingSet = new Set(currentFileData.followingList);
    manuallyAddedFollowing.forEach(user => effectiveFollowingSet.add(user));
    manuallyUnfollowedList.forEach(user => effectiveFollowingSet.delete(user));
    const effectiveFollowingList = Array.from(effectiveFollowingSet);

    followingListModal.style.display = 'flex';
    renderAccountList(followingListContainer, effectiveFollowingList);
    followingSearchInput.value = ''; // Clear search input
    followingSearchInput.focus();
}

// New: Close Following List Modal
function closeFollowingListModalFunc() {
    followingListModal.style.display = 'none';
}

// --- END OF NEW MODAL-RELATED FUNCTIONS ---

    // Function to update analytics metrics
    function updateAnalyticsMetrics(unfollowedYouCalculated, newFollowersCalculated, unfollowedAccountsList, newFollowerAccountsList) {
        // User requested to swap the display:
        // "New Followers" label should show actual "Unfollowed You" count
        // "Unfollowed You" label should show actual "New Followers" count
        newFollowersCountElem.textContent = unfollowedYouCalculated; // This is the count of people who unfollowed you
        unfollowedYouCountElem.textContent = newFollowersCalculated; // This is the count of new followers you gained

        // And swap the lists to match the swapped counts
        renderNewFollowersList(unfollowedAccountsList); // Render accounts that unfollowed you under "New Followers" list
        renderUnfollowedAccountsList(newFollowerAccountsList); // Render accounts that newly followed you under "Unfollowed You" list
    }

    // Function to update Accounts Management metrics
    function updateAccountsManagementMetrics() {
        // Accounts to Review
        const accountsToRemoveCountValue = accountsToRemoveList.length;
        accountsToRemoveCount.textContent = accountsToRemoveCountValue;
        accountsToRemoveCount.classList.remove('accounts-to-remove-green', 'accounts-to-remove-orange', 'accounts-to-remove-red');
        if (accountsToRemoveCountValue >= 0 && accountsToRemoveCountValue <= 15) {
            accountsToRemoveCount.classList.add('accounts-to-remove-green');
        } else if (accountsToRemoveCountValue > 15 && accountsToRemoveCountValue <= 30) {
            accountsToRemoveCount.classList.add('accounts-to-remove-orange');
        } else {
            accountsToRemoveCount.classList.add('accounts-to-remove-red');
        }

        // Total Accounts Removed
        totalAccountsRemovedCount.textContent = removedAccountsList.length;

        // Approved Accounts
        approvedAccountsCount.textContent = approvedAccountsList.length;

        // Oldest Account to Remove
        if (accountsToRemoveList.length > 0) {
            const oldestAccount = accountsToRemoveList.reduce((prev, curr) => {
                return (prev.timestamp || Infinity) < (curr.timestamp || Infinity) ? prev : curr;
            });
            const timeInfo = formatTimeDifference(oldestAccount.timestamp);
            oldestAccountToRemoveAge.textContent = timeInfo.text;
        } else {
            oldestAccountToRemoveAge.textContent = 'N/A';
        }
    }


function renderApprovedUsersList(users) {
    const listContainer = document.getElementById('approvedUsersList'); // Ensure this ID matches your HTML element for the list
    if (!listContainer) {
        console.error("Error: approvedUsersList element not found!");
        return; // Exit if the container element doesn't exist
    }

    listContainer.innerHTML = ''; // Clear existing content

    console.log("Inside renderApprovedUsersList. Received users:", users);

    if (users && Array.isArray(users) && users.length > 0) {
        users.forEach(user => {
            const li = document.createElement('li');
            // Check if 'user' is an object and has a 'username' property, or if it's just a string
            if (typeof user === 'object' && user !== null && user.username) {
                li.textContent = user.username;
                console.log("Rendering user (object):", user.username);
            } else if (typeof user === 'string') {
                li.textContent = user;
                console.log("Rendering user (string):", user);
            } else {
                console.warn("Skipping unknown user format:", user);
                return; // Skip this item if format is unexpected
            }
            // Add styling classes if needed (e.g., for TailwindCSS or your custom styles)
            // li.classList.add('py-2', 'border-b', 'border-gray-200');

            listContainer.appendChild(li);
        });
    } else {
        const li = document.createElement('li');
        li.textContent = 'No approved users found or data is malformed.';
        // Add styling classes if needed
        // li.classList.add('py-2', 'text-gray-500');
        listContainer.appendChild(li);
        console.log("No approved users to render or 'users' is not an array:", users);
    }
}

    // Event Listeners for Approved Users Modal
    if (approvedAccountsCard) {
        approvedAccountsCard.addEventListener('click', () => {
            // Ensure the list container is completely clear before rendering
            approvedUsersListElem.innerHTML = '';
            // Log the content of approvedAccountsList to console for debugging
            console.log("Approved Accounts List clicked. Data to render:", approvedAccountsList);
            renderApprovedUsersList(approvedAccountsList); // Use the global approvedAccountsList
            approvedUsersModal.style.display = 'flex';
        });
    }

    if (closeApprovedUsersModal) {
        closeApprovedUsersModal.addEventListener('click', () => {
            approvedUsersModal.style.display = 'none';
        });
    }

    // Close modal if clicking outside
    if (approvedUsersModal) {
        window.addEventListener('click', (event) => {
            if (event.target === approvedUsersModal) {
                approvedUsersModal.style.display = 'none';
            }
        });
    }

    // Function to show dashboard and hide other sections
    function showDashboard() {
        heroSection.classList.add('hidden');
        featuresSection.classList.add('hidden');
        uploadSection.classList.add('hidden');
        analyticsSection.classList.add('hidden'); // Hide analytics section
        accountsSection.classList.add('hidden'); // Hide accounts section
        bannedUsersPageSection.classList.add('hidden'); // New: Hide banned users page
        addAccountPageSection.classList.add('hidden'); // Hide add account page
        dashboardSection.classList.remove('hidden');
        
        // Ensure the dashboard displays the current data if available
        if (currentFileData) {
            // Recalculate allNonFollowers based on current safeUsers
            allNonFollowers = originalNotFollowingBack.filter(account => !safeUsers.includes(account.username)); // Filter by username
            
            // Calculate current total following including manual additions and removals
            const effectiveFollowingCount = (currentFileData.followingList || []).length + manuallyAddedFollowing.length - manuallyUnfollowedList.length;

            updateDashboardMetrics(
                effectiveFollowingCount,
                currentFileData.totalFollowers,
                allNonFollowers.length, // Filtered count
                originalNotFollowingBack.length, // Total count
                (currentFileData.recentlyUnfollowedProfiles || []).length
            );
            applyFiltersAndRenderAccounts(); // Apply filters when showing dashboard
        } else {
            // If no data, reset metrics and show "No data" message
            updateDashboardMetrics(0, 0, 0, 0, 0);
            renderAccounts([]);
        }
        dashboardSection.scrollIntoView({ behavior: 'smooth' });
    }

    // Function to find and load the upload with the most analytics change
    async function findAndLoadBestAnalyticsData() {
        if (!currentUserId || !dbInstance || allUserUploadsMetadata.length < 2) {
            // Not enough data for analytics comparison, load latest (which will show 0 changes)
            await loadLatestData();
            return;
        }

        let bestUploadIdForAnalytics = allUserUploadsMetadata[0].id; // Default to the very latest upload
        let maxTotalChange = -1;

        // Iterate through uploads, considering each as the "current" for which we want to see analytics
        // The loop goes up to the second to last element, because we need a "next" element (older) for comparison.
        for (let i = 0; i < allUserUploadsMetadata.length - 1; i++) {
            const currentUploadMetadata = allUserUploadsMetadata[i]; // This is the newer timestamp
            const olderUploadMetadata = allUserUploadsMetadata[i + 1]; // This is the older timestamp

            // Fetch full data for both current and older uploads
            const currentUploadDocRef = doc(dbInstance, `artifacts/${appId}/users/${currentUserId}/userUploads`, currentUploadMetadata.id);
            const olderUploadDocRef = doc(dbInstance, `artifacts/${appId}/users/${currentUserId}/userUploads`, olderUploadMetadata.id);

            const [currentDocSnap, olderDocSnap] = await Promise.all([
                getDoc(currentUploadDocRef),
                getDoc(olderUploadDocRef)
            ]);

            if (currentDocSnap.exists() && olderDocSnap.exists()) {
                const currentData = currentDocSnap.data();
                const olderData = olderDocSnap.data();

                const currentFollowersSet = new Set(currentData.followersList);
                const previousFollowersSet = new Set(olderData.followersList);

                // Calculate unfollowed (lost followers) from older to current
                const unfollowedCount = Array.from(previousFollowersSet).filter(
                    follower => !currentFollowersSet.has(follower)
                ).length;

                // Calculate new followers (gained followers) from older to current
                const newFollowersCount = Array.from(currentFollowersSet).filter(
                    follower => !previousFollowersSet.has(follower)
                ).length;

                const totalChange = unfollowedCount + newFollowersCount;

                if (totalChange > maxTotalChange) {
                    maxTotalChange = totalChange;
                    bestUploadIdForAnalytics = currentUploadMetadata.id; // The ID of the newer upload in the pair
                }
            }
        }

        // Load the data for the best period found
        await loadDataForUpload(bestUploadIdForAnalytics);
        // Ensure the selector reflects the chosen upload
        dataUploadSelectorAnalytics.value = bestUploadIdForAnalytics;
        dataUploadSelectorDashboard.value = bestUploadIdForAnalytics;
    }

    // Function to show analytics and hide other sections
    function showAnalytics() {
        heroSection.classList.add('hidden');
        featuresSection.classList.add('hidden');
        uploadSection.classList.add('hidden');
        dashboardSection.classList.add('hidden'); // Hide dashboard section
        accountsSection.classList.add('hidden'); // Hide accounts section
        bannedUsersPageSection.classList.add('hidden'); // New: Hide banned users page
        addAccountPageSection.classList.add('hidden'); // Hide add account page
        analyticsSection.classList.remove('hidden'); // Show analytics section

        // Call the new function to find and load best analytics data
        findAndLoadBestAnalyticsData();
        analyticsSection.scrollIntoView({ behavior: 'smooth' });
    }

    // Function to show Accounts Management section
    function showAccountsManagement(viewMode = 'toReview') {
        heroSection.classList.add('hidden');
        featuresSection.classList.add('hidden');
        uploadSection.classList.add('hidden');
        dashboardSection.classList.add('hidden');
        analyticsSection.classList.add('hidden');
        bannedUsersPageSection.classList.add('hidden'); // New: Hide banned users page
        addAccountPageSection.classList.add('hidden'); // Hide add account page
        accountsSection.classList.remove('hidden');

        currentAccountsViewMode = viewMode; // Set the view mode
        applyAccountsManagementFiltersAndRender(); // Apply filters and render
        updateAccountsManagementMetrics(); // Update new metrics for accounts management
        accountsSection.scrollIntoView({ behavior: 'smooth' });
    }

    // Function to show the new Banned Users Page
    function showBannedUsersPage() {
        heroSection.classList.add('hidden');
        featuresSection.classList.add('hidden');
        uploadSection.classList.add('hidden');
        dashboardSection.classList.add('hidden');
        analyticsSection.classList.add('hidden');
        accountsSection.classList.add('hidden');
        addAccountPageSection.classList.add('hidden'); // Hide add account page
        bannedUsersPageSection.classList.remove('hidden'); // Show banned users page

        // Re-render orange list users when page is shown
        renderOrangeListUsers(originalNotFollowingBack);
        // Clear previous check results
        bannedUsersMatchesDisplay.classList.add('hidden');
        matchesCountText.textContent = '';
        matchesList.innerHTML = '';
        bannedUsersFileInput.value = '';
        bannedUsersTextInput.value = '';

        bannedUsersPageSection.scrollIntoView({ behavior: 'smooth' });
    }

    // Function to show the new Add Account Page
    function showAddAccountPage() {
        heroSection.classList.add('hidden');
        featuresSection.classList.add('hidden');
        uploadSection.classList.add('hidden');
        dashboardSection.classList.add('hidden');
        analyticsSection.classList.add('hidden');
        accountsSection.classList.add('hidden');
        bannedUsersPageSection.classList.add('hidden');
        addAccountPageSection.classList.remove('hidden'); // Show add account page

        renderAddedAccountsPreview(); // Render the list of manually added accounts
        singleAddAccountInput.value = ''; // Clear input fields
        bulkAddAccountInput.value = '';

        addAccountPageSection.scrollIntoView({ behavior: 'smooth' });
    }


    // Function to show landing page and hide dashboard
    function showLandingPage() {
        heroSection.classList.remove('hidden');
        featuresSection.classList.remove('hidden');
        uploadSection.classList.remove('hidden');
        dashboardSection.classList.add('hidden');
        analyticsSection.classList.add('hidden'); // Hide analytics section
        accountsSection.classList.add('hidden'); // Hide accounts section
        bannedUsersPageSection.classList.add('hidden'); // New: Hide banned users page
        addAccountPageSection.classList.add('hidden'); // Hide add account page
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Authentication Functions
    function openAuthModal() {
        authModal.style.display = 'flex';
    }

    function closeAuthModalFunc() {
        authModal.style.display = 'none';
        authEmailInput.value = '';
        authPasswordInput.value = '';
    }

    // The event listeners for auth buttons will be added inside window.onload
    // to ensure elements are available. Their logic remains the same.
    const handleLogin = async () => {
      // This function is primarily for the "Access Premium" button for unauthenticated users
      if (authInstance.currentUser) {
            // If already logged in, check if data exists and go to dashboard/upload
            if (currentFileData && currentFileData.fileName) {
                showDashboard();
            } else {
                showUploadSection(false);
                showAlert('Please upload your Instagram data to see the dashboard.', 'info');
            }
      } else {
            openAuthModal(); // Open the authentication modal
      }
    };

    const handleLogout = async () => {
      try {
        await signOut(authInstance);
        showNotification('Logged out successfully!', 'success');
        // New: Unsubscribe when user logs out
        if (unsubscribeFromFirebase) {
            unsubscribeFromFirebase();
            unsubscribeFromFirebase = null; // Clear the reference
            console.log("Firebase listener unsubscribed on logout.");
        }
        currentFileData = null; // Clear data on logout
        allNonFollowers = [];
        originalNotFollowingBack = [];
        safeUsers = [];
        bannedUsers = []; // Clear banned users on logout
        allUserUploadsMetadata = []; // Clear upload metadata
        accountsManuallyAddedForReview = []; // Reset accounts management list
        approvedAccountsList = [];
        removedAccountsList = [];
        manuallyUnfollowedList = []; // Reset manually unfollowed list
        accountsToRemoveList = []; // Reset accountsToRemoveList
        manuallyAddedFollowing = []; // Reset manually added following
        updateDashboardMetrics(0, 0, 0, 0, 0);
        updateAnalyticsMetrics(0, 0, [], []); // Reset analytics metrics
        updateAccountsManagementMetrics(); // Reset accounts management metrics
        populateUploadSelectors(); // Clear selectors
        showLandingPage(); // Go back to landing page after logout
      } catch (error) {
        showAlert('Error during logout: ' + error.message, 'error');
      }
    };


    // Function to show the correct upload state
    // This function is now mostly for the landing page upload section
    function showUploadSection(showSuccess = false, fileName = '', fileSize = '') {
        heroSection.classList.add('hidden');
        featuresSection.classList.remove('hidden'); // Keep features visible
        dashboardSection.classList.add('hidden');
        analyticsSection.classList.add('hidden'); // Hide analytics section
        accountsSection.classList.add('hidden'); // Hide accounts section
        bannedUsersPageSection.classList.add('hidden'); // New: Hide banned users page
        addAccountPageSection.classList.add('hidden'); // Hide add account page
        uploadSection.classList.remove('hidden'); // Ensure upload section is visible

        if (showSuccess) {
            initialUploadArea.classList.add('hidden');
            uploadSuccessState.classList.remove('hidden');
            uploadedFileName.textContent = fileName;
            uploadedFileSize.textContent = fileSize;
        } else {
            initialUploadArea.classList.remove('hidden');
            uploadSuccessState.classList.add('hidden');
        }
        // Scroll to upload section
        uploadSection.scrollIntoView({ behavior: 'smooth' });
    }

    // Handle "Find My Non-Followers" button click (on landing page upload success state)
    // This event listener will be set up in window.onload
    const findNonFollowersButtonClickHandler = () => {
        if (currentFileData) {
            // Ensure allNonFollowers is updated based on current safeUsers
            allNonFollowers = originalNotFollowingBack.filter(account => !safeUsers.includes(account.username)); // Filter by username
            
            // Calculate current total following including manual additions and removals
            const effectiveFollowingCount = (currentFileData.followingList || []).length + manuallyAddedFollowing.length - manuallyUnfollowedList.length;

            updateDashboardMetrics(
                effectiveFollowingCount,
                currentFileData.totalFollowers,
                allNonFollowers.length, // Filtered count
                originalNotFollowingBack.length, // Total count
                (currentFileData.recentlyUnfollowedProfiles || []).length
            );
            showDashboard();
        } else {
            showAlert('No data processed yet. Please upload a file.', 'info');
        }
    };


    // Handle "Remove File" button click
    // This event listener will be set up in window.onload
    const removeFileButtonClickHandler = async () => {
        if (currentUserId && authInstance.currentUser && currentFileData) {
            try {
                // Delete data from Firestore
                const userDocRef = doc(dbInstance, `artifacts/${appId}/users/${currentUserId}/userUploads`, currentFileData.id);
                await deleteDoc(userDocRef); // This completely deletes the document
                console.log('Current user data cleared from Firestore.');
                await loadAllUserUploads(); // Reload metadata to update dropdowns
                await loadLatestData(); // Load the new latest or reset if no more uploads
                showNotification('Current file removed. You can upload a new one.', 'info');
            } catch (error) {
                console.error('Error clearing data from Firestore:', error);
                showAlert('Failed to clear data from storage.', 'error');
            }
        } else {
             showAlert('No file selected to remove or not logged in.', 'info');
        }

        currentFileData = null; // Clear processed data
        allNonFollowers = []; // Clear non-followers list
        originalNotFollowingBack = []; // Clear original list
        safeUsers = [];
        bannedUsers = []; // Clear banned users
        allUserUploadsMetadata = []; // Clear upload metadata
        accountsManuallyAddedForReview = []; // Reset accounts management list
        approvedAccountsList = [];
        removedAccountsList = [];
        manuallyUnfollowedList = []; // Reset manually unfollowed list
        accountsToRemoveList = []; // Reset accountsToRemoveList
        manuallyAddedFollowing = []; // Clear manually added following
        updateDashboardMetrics(0, 0, 0, 0, 0); // Reset dashboard metrics
        updateAnalyticsMetrics(0, 0, [], []); // Reset analytics metrics
        updateAccountsManagementMetrics(); // Reset accounts management metrics
        renderUnfollowedProfilesList([]); // Clear unfollowed profiles list
        fileInput.value = ''; // Clear the file input on landing page
        modalFileInput.value = ''; // Clear the file input in modal
        showUploadSection(false); // Show initial upload state on landing page
    };

    // Helper function to extract JSON from a ZipEntry, handling both .json and .html files
    async function extractJsonFromZipEntry(zipEntry) {
        if (!zipEntry) return null;

        const content = await zipEntry.async('text');
        try {
            // First, try parsing directly as JSON
            return JSON.parse(content);
        } catch (e) {
            // If not direct JSON, try parsing as HTML and finding JSON within it
            const parser = new DOMParser();
            const doc = parser.parseFromString(content, 'text/html');

            // Look for JSON in <pre> tags
            const preElements = doc.querySelectorAll('pre');
            for (const pre of preElements) {
                try {
                    const jsonData = JSON.parse(pre.textContent);
                    // Basic check to see if it looks like Instagram data
                    if (jsonData.relationships_following || jsonData.relationships_unfollowed_users || (Array.isArray(jsonData) && jsonData.every(item => item.string_list_data)) || (jsonData.messages && Array.isArray(jsonData.messages))) {
                        return jsonData;
                    }
                } catch (e) { /* not valid JSON or not the right structure */ }
            }

            // Look for JSON in <script type="application/json"> tags
            const scriptElements = doc.querySelectorAll('script[type="application/json"]');
            for (const script of scriptElements) {
                try {
                    const jsonData = JSON.parse(script.textContent);
                    if (jsonData.relationships_following || jsonData.relationships_unfollowed_users || (Array.isArray(jsonData) && jsonData.every(item => item.string_list_data)) || (jsonData.messages && Array.isArray(jsonData.messages))) {
                        return jsonData;
                    }
                } catch (e) { /* not valid JSON or not the right structure */ }
            }
        }
        return null; // No valid JSON found
    }

    async function handleFiles(files) {
      if (files.length === 0) {
        showAlert('No file was selected or dropped.', 'info');
        return;
      }

      const file = files[0];
      const fileName = file.name;
      const fileExtension = fileName.split('.').pop().toLowerCase();

      if (!['zip', 'html'].includes(fileExtension)) {
        showAlert('Invalid file type. Please upload a .zip or .html file.', 'error');
        return;
      }

      const MAX_FILE_SIZE_MB = 200;
      if (file.size > MAX_FILE_SIZE_MB * 1024 * 1024) { 
        showAlert(`File size exceeds ${MAX_FILE_SIZE_MB}MB. Please choose a smaller file.`, 'error');
        return;
      }

      let followingData = null;
      let followersData = null;
      let recentlyUnfollowedData = null; // New variable for recently unfollowed

      try {
        if (fileExtension === 'zip') {
            const zip = await JSZip.loadAsync(file);

            // Define possible paths for each file type (JSON or HTML)
            const followingPaths = ['connections/followers_and_following/following.json', 'connections/followers_and_following/following.html'];
            const followersPaths = ['connections/followers_and_following/followers_1.json', 'connections/followers_and_following/followers_1.html'];
            const recentlyUnfollowedPaths = ['connections/followers_and_following/recently_unfollowed_profiles.json', 'connections/followers_and_following/recently_unfollowed_profiles.html'];
            
            // Function to find and extract data from the first available path
            const findAndExtract = async (paths) => {
                for (const path of paths) {
                    const entry = zip.file(path);
                    if (entry) {
                        const data = await extractJsonFromZipEntry(entry);
                        if (data) return data;
                    }
                }
                return null;
            };

            followingData = await findAndExtract(followingPaths);
            followersData = await findAndExtract(followersPaths);
            recentlyUnfollowedData = await findAndExtract(recentlyUnfollowedPaths);

            // Handle missing data gracefully
            if (!followingData) {
                showNotification(`'following.json' or 'following.html' not found in ZIP. Following stats may be incomplete.`, 'info');
            }
            if (!followersData) {
                showNotification(`'followers_1.json' or 'followers_1.html' not found in ZIP. Follower stats may be incomplete.`, 'info');
            }
            if (!recentlyUnfollowedData) {
                showNotification(`'recently_unfollowed_profiles.json' or '.html' not found in ZIP. "People You Unfollowed" stats will be unavailable.`, 'info');
            }

            // No message file parsing for Accounts Management anymore

        } else if (fileExtension === 'html') {
            const htmlContent = await file.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');

            // Find JSON data within <pre> tags, which is common for Instagram HTML exports
            const preElements = doc.querySelectorAll('pre');
            let foundFollowing = false;
            let foundFollowers = false;
            let foundRecentlyUnfollowed = false;

            for (const pre of preElements) {
                try {
                    const jsonData = JSON.parse(pre.textContent);
                    if (jsonData.relationships_following && !foundFollowing) {
                        followingData = jsonData;
                        foundFollowing = true;
                    } else if (jsonData.relationships_unfollowed_users && Array.isArray(jsonData.relationships_unfollowed_users) && !foundRecentlyUnfollowed) {
                        recentlyUnfollowedData = jsonData;
                        foundRecentlyUnfollowed = true;
                    } else if (Array.isArray(jsonData) && jsonData.every(item => item.string_list_data) && !foundFollowers) {
                        // This could be followers_1.json. We need a heuristic to distinguish.
                        // Assume it's followers if not already found and doesn't match unfollowed structure.
                        if (!jsonData.some(item => item.title === "Recently Unfollowed")) { // Simple check to distinguish
                            followersData = jsonData;
                            foundFollowers = true;
                        }
                    }
                } catch (e) {
                    console.warn("Could not parse JSON from a pre tag or it's not expected data:", e);
                }
            }

            // Fallback: Try to find JSON in script tags (less common for Instagram, but good to have)
            if (!foundFollowing || !foundFollowers || !foundRecentlyUnfollowed) {
                const scriptElements = doc.querySelectorAll('script[type="application/json"]');
                for (const script of scriptElements) {
                    try {
                        const jsonData = JSON.parse(script.textContent);
                        if (jsonData.relationships_following && !foundFollowing) {
                            followingData = jsonData;
                            foundFollowing = true;
                        } else if (jsonData.relationships_unfollowed_users && Array.isArray(jsonData.relationships_unfollowed_users) && !foundRecentlyUnfollowed) {
                            recentlyUnfollowedData = jsonData;
                            foundRecentlyUnfollowed = true;
                        } else if (Array.isArray(jsonData) && jsonData.every(item => item.string_list_data) && !foundFollowers) {
                            if (!jsonData.some(item => item.title === "Recently Unfollowed")) {
                                followersData = jsonData;
                                foundFollowers = true;
                            }
                        }
                    } catch (e) {
                        console.warn("Could not parse JSON from a script tag:", e);
                    }
                }
            }

            // Handle missing data gracefully for HTML
            if (!followingData) {
                showNotification(`Following data not found in HTML. Following stats may be incomplete.`, 'info');
            }
            if (!followersData) {
                showNotification(`Followers data not found in HTML. Follower stats may be incomplete.`, 'info');
            }
            if (!recentlyUnfollowedData) {
                showNotification(`Recently unfollowed profiles data not found in HTML. "People You Unfollowed" stats will be unavailable.`, 'info');
            }
        }

        // Process recently unfollowed data for banned users list
        if (recentlyUnfollowedData && Array.isArray(recentlyUnfollowedData.relationships_unfollowed_users)) {
            recentlyUnfollowedData.relationships_unfollowed_users.forEach(item => {
                if (item.string_list_data && item.string_list_data.length > 0) {
                    const username = item.string_list_data[0].value.toLowerCase(); // Store in lowercase
                    if (!bannedUsers.includes(username)) {
                        bannedUsers.push(username);
                    }
                }
            });
            bannedUsers.sort(); // Keep sorted
            console.log("Banned users updated from recently unfollowed:", bannedUsers);
        } else if (recentlyUnfollowedData) {
            console.warn("recently_unfollowed_profiles data found but did not contain expected 'relationships_unfollowed_users' array.");
        }


        const followingListFromFile = new Set(); // This will be the base from the file
        const followingMapFromFile = new Map(); // To store timestamps from the file
        if (followingData && followingData.relationships_following) {
            followingData.relationships_following.forEach(item => {
                if (item.string_list_data && item.string_list_data.length > 0) {
                    const username = item.string_list_data[0].value;
                    const timestamp = item.string_list_data[0].timestamp;
                    followingListFromFile.add(username);
                    followingMapFromFile.set(username, timestamp);
                }
            });
        }

        const followersUsernames = new Set();
        if (followersData) {
            followersData.forEach(item => {
                if (item.string_list_data && item.string_list_data.length > 0) {
                    followersUsernames.add(item.string_list_data[0].value);
                }
            });
        }

        const totalFollowers = followersUsernames.size;
        
        // Calculate originalNotFollowingBack based on file data only
        const calculatedOriginalNotFollowingBack = [];
        followingListFromFile.forEach(username => {
            if (!followersUsernames.has(username)) {
                const timestamp = followingMapFromFile.get(username);
                calculatedOriginalNotFollowingBack.push({ username: username, timestamp: timestamp || null });
            }
        });
        originalNotFollowingBack = calculatedOriginalNotFollowingBack;

        // Effective following list for display and calculations:
        // Start with users from the file, add manually added, then remove manually unfollowed
        let effectiveFollowingSet = new Set(Array.from(followingListFromFile));
        manuallyAddedFollowing.forEach(user => effectiveFollowingSet.add(user));
        manuallyUnfollowedList.forEach(user => effectiveFollowingSet.delete(user));
        const effectiveFollowingCount = effectiveFollowingSet.size;


        // Filter notFollowingBack based on current safeUsers
        allNonFollowers = originalNotFollowingBack.filter(account => !safeUsers.includes(account.username));

        // If currentFileData exists, use its approved/removed/banned lists. Otherwise, start fresh.
        const currentApproved = currentFileData ? currentFileData.approvedAccounts || [] : [];
        const currentRemoved = currentFileData ? currentFileData.removedAccounts || [] : [];
        const currentBanned = bannedUsers; // Banned users are already updated from recently_unfollowed_profiles.json/html and existing state
        const currentManuallyAddedForReview = currentFileData ? currentFileData.accountsManuallyAddedForReview || [] : [];
        const currentManuallyAddedFollowing = currentFileData ? currentFileData.manuallyAddedFollowing || [] : [];
        const currentManuallyUnfollowedList = currentFileData ? currentFileData.manuallyUnfollowedList || [] : [];
        const currentRecentlyUnfollowedProfiles = recentlyUnfollowedData ? recentlyUnfollowedData.relationships_unfollowed_users || [] : [];


        // Prepare data for saving
        const uploadTimestamp = Math.floor(Date.now() / 1000); // Current timestamp in seconds
        const uploadId = `upload_${uploadTimestamp}`; // Unique ID for this upload

        const dataToSave = {
            timestamp: uploadTimestamp,
            fileName: file.name,
            totalFollowing: effectiveFollowingCount, // Save the effective count
            totalFollowers,
            followingList: Array.from(followingListFromFile), // Save the original list from file
            followersList: Array.from(followersUsernames), // Save as array for Firestore
            originalNotFollowingBack, // This is based on file data only
            youDontFollowBackCount: totalFollowers - new Set(Array.from(followingListFromFile).concat(manuallyAddedFollowing)).size, // This is the "followers I don't follow back" count based on combined following
            recentlyUnfollowedProfiles: currentRecentlyUnfollowedProfiles, // New: Save the raw data for "People You Unfollowed"
            safeUsers: safeUsers, // Current safe users
            bannedUsers: currentBanned, // New: Save current banned users
            accountsManuallyAddedForReview: currentManuallyAddedForReview, // Save accounts manually added for review
            approvedAccounts: currentApproved, // Save current approved accounts
            removedAccounts: currentRemoved, // Save current removed accounts
            manuallyAddedFollowing: currentManuallyAddedFollowing, // Save manually added following
            manuallyUnfollowedList: currentManuallyUnfollowedList // Save manually unfollowed list
        };

        // Save data to Firestore
        if (currentUserId && authInstance.currentUser) {
            const userUploadsRef = collection(dbInstance, `artifacts/${appId}/users/${currentUserId}/userUploads`);
            await setDoc(doc(userUploadsRef, uploadId), dataToSave);
            console.log('User data saved to Firestore with ID:', uploadId);
            await loadAllUserUploads(); // Reload all uploads to update dropdowns
            await loadDataForUpload(uploadId); // Load the newly uploaded data
            showNotification('Instagram data uploaded successfully!', 'success');
            showDashboard(); // Go to dashboard after successful upload
        } else {
            // For unauthenticated users, data is temporary
            currentFileData = { id: uploadId, ...dataToSave };
            // Update global lists for unauthenticated users
            approvedAccountsList = currentApproved;
            removedAccountsList = currentRemoved;
            bannedUsers = currentBanned; // New: Update global banned users for unauthenticated users
            accountsManuallyAddedForReview = currentManuallyAddedForReview; // Update global manually added for review
            manuallyAddedFollowing = currentManuallyAddedFollowing; // Update global manually added following
            manuallyUnfollowedList = currentManuallyUnfollowedList; // Update global manually unfollowed list
            accountsToRemoveList = []; // Initialize accountsToRemoveList for unauthenticated user

            // Calculate current total following including manual additions and removals
            const effectiveFollowingCountForUnauth = (currentFileData.followingList || []).length + manuallyAddedFollowing.length - manuallyUnfollowedList.length;

            updateDashboardMetrics(
                effectiveFollowingCountForUnauth,
                currentFileData.totalFollowers,
                allNonFollowers.length,
                originalNotFollowingBack.length,
                (currentFileData.recentlyUnfollowedProfiles || []).length
            );
            updateAnalyticsMetrics(0, 0, [], []);
            updateAccountsManagementMetrics(); // Update new metrics
            renderAccounts(allNonFollowers); // Render non-followers
            applyAccountsManagementFiltersAndRender(); // Render accounts to Review
            renderOrangeListUsers(originalNotFollowingBack); // New: Render orange list users
            renderUnfollowedProfilesList(currentFileData.recentlyUnfollowedProfiles || []); // Render unfollowed profiles list
            showDashboard(); // Show dashboard section
            showAlert('Instagram data processed. Log in to save your data and access full analytics!', 'info');
        }
        fileInput.value = '';
        modalFileInput.value = '';
        closeUploadDataModalFunc();
      } catch (error) {
        console.error('Error processing file:', error);
        showAlert('Failed to process Instagram data. Please ensure it\'s a valid Instagram data export file (.zip or .html) and contains the correct files. Error: ' + error.message, 'error');
        showUploadSection(false);
      }
    }


    // Safe Users Modal Functions
    function openSafeUsersModal() {
        safeUsersModal.style.display = 'flex';
        renderSafeUsersList();
        populateSafeUserSuggestions(); // Populate suggestions when modal opens
    }

    function closeSafeUsersModalFunc() {
        safeUsersModal.style.display = 'none';
        // Clear input fields when closing
        safeUserInput.value = '';
        bulkSafeUserInput.value = '';
        safeUserSuggestionsDatalist.innerHTML = ''; // Clear suggestions
    }

    function renderSafeUsersList() {
        safeUsersListElem.innerHTML = '';
        if (safeUsers.length === 0) {
            safeUsersListElem.innerHTML = '<p class="text-gray-500 text-center">No safe users added yet.</p>';
            return;
        }
        safeUsers.forEach(user => {
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center py-2 px-3 border-b border-gray-600 last:border-b-0 text-gray-200';
            div.innerHTML = `
                <span>${user}</span>
                <button data-user="${user}" class="remove-safe-user-btn text-red-400 hover:text-red-500 transition-colors">
                    <i class="fas fa-times-circle"></i>
                </button>
            `;
            safeUsersListElem.appendChild(div);
        });

        // Add event listeners to new remove buttons
        document.querySelectorAll('.remove-safe-user-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const userToRemove = e.currentTarget.dataset.user;
                removeSafeUser(userToRemove);
            });
        });
    }

    function populateSafeUserSuggestions() {
        safeUserSuggestionsDatalist.innerHTML = '';
        if (!originalNotFollowingBack || originalNotFollowingBack.length === 0) {
            return;
        }

        const currentInput = safeUserInput.value.toLowerCase();
        const suggestedUsers = new Set();

        originalNotFollowingBack.forEach(account => {
            const username = account.username;
            // Suggest if not already safe and matches current input
            if (!safeUsers.includes(username) && username.toLowerCase().includes(currentInput)) {
                suggestedUsers.add(username);
            }
        });

        Array.from(suggestedUsers).sort().forEach(username => {
            const option = document.createElement('option');
            option.value = username;
            safeUserSuggestionsDatalist.appendChild(option);
        });
    }

    // This event listener will be set up in window.onload
    const safeUserInputHandler = () => {
        populateSafeUserSuggestions();
    };


    async function addSafeUser(username) {
        if (username && !safeUsers.includes(username)) {
            safeUsers.push(username);
            return true; // Indicate success
        }
        return false; // Indicate already exists or invalid
    }

    async function processAndSaveSafeUsers(newUsersAdded = false) {
        if (newUsersAdded && currentFileData) {
            safeUsers.sort(); // Keep the list sorted
            currentFileData.safeUsers = safeUsers; // Update currentFileData as well
            await saveSafeUsersToFirestore();
            // Re-render dashboard metrics and non-followers list
            allNonFollowers = originalNotFollowingBack.filter(account => !safeUsers.includes(account.username)); // Filter by username
            applyFiltersAndRenderAccounts(); // Re-apply filters and render
            
            // Calculate current total following including manual additions and removals
            const effectiveFollowingCount = (currentFileData.followingList || []).length + manuallyAddedFollowing.length - manuallyUnfollowedList.length;

            // Update dashboard metrics to reflect the change in filtered non-followers count
            updateDashboardMetrics(
                effectiveFollowingCount,
                currentFileData.totalFollowers,
                allNonFollowers.length, // Updated filtered count
                originalNotFollowingBack.length,
                (currentFileData.recentlyUnfollowedProfiles || []).length
            );
        }
        renderSafeUsersList(); // Always re-render the modal list
    }

    // These event listeners will be set up in window.onload
    const addSafeUserButtonClickHandler = async () => {
        const username = safeUserInput.value.trim();
        if (username) {
            const added = await addSafeUser(username);
            if (added) {
                safeUserInput.value = ''; // Clear input only on success
                await processAndSaveSafeUsers(true);
                showNotification('Safe user added!', 'success'); // Green success popup
            } else {
                showNotification('User is already in the safe list.', 'info');
            }
        }
    };

    // Corrected function for bulk safe user add
    const addBulkSafeUserButtonClickHandler = async () => {
        const text = bulkSafeUserInput.value.trim();
        if (!text) {
            showNotification('Please enter usernames in the bulk input area.', 'info');
            return;
        }

        const usernames = text.split(/[\n,]+/).map(name => name.trim()).filter(name => name.length > 0);
        let anyAdded = false;
        const alreadyInList = [];

        for (const username of usernames) {
            const added = await addSafeUser(username);
            if (added) {
                anyAdded = true;
            } else {
                alreadyInList.push(username);
            }
        }

        if (anyAdded) {
            bulkSafeUserInput.value = '';
            await processAndSaveSafeUsers(true);
            showNotification('Safe users added!', 'success');
            closeSafeUsersModalFunc(); // Close modal after bulk add
        } else if (alreadyInList.length > 0) {
            showAlert(`All entered users are already in the safe list: ${alreadyInList.join(', ')}`, 'info');
        } else {
            showNotification('No valid users were entered.', 'info');
        }
    };


    async function removeSafeUser(username) {
        safeUsers = safeUsers.filter(user => user !== username);
        await processAndSaveSafeUsers(true); // Treat removal as a change that needs saving
        showNotification('Safe user removed!', 'info'); // Info popup for removal
    }

    async function saveSafeUsersToFirestore() {
        if (currentUserId && authInstance.currentUser && dbInstance && currentFileData) {
            try {
                const userDocRef = doc(dbInstance, `artifacts/${appId}/users/${currentUserId}/userUploads`, currentFileData.id);
                // Update only the safeUsers array
                await setDoc(userDocRef, { 
                    safeUsers: currentFileData.safeUsers,
                }, { merge: true }); // Use merge: true to only update the safeUsers field
                console.log('Safe users saved to Firestore for current upload.');
            } catch (error) {
                console.error('Error saving safe users to Firestore:', error);
                showAlert('Failed to save safe users to storage.', 'error');
            }
        } else {
            console.warn('Cannot save safe users: User not authenticated or currentFileData not available.');
        }
    }

    // Banned Users Add Modal Functions (NEW)
    function openBannedUsersAddModal() {
        bannedUsersAddModal.style.display = 'flex';
        renderBannedUsersList();
        populateBannedUserSuggestions(); // Populate suggestions when modal opens
    }

    function closeBannedUsersAddModalFunc() {
        bannedUsersAddModal.style.display = 'none';
        bannedUserInput.value = '';
        bulkBannedUserInput.value = '';
        bannedUserSuggestionsDatalist.innerHTML = ''; // Clear suggestions
    }

    function renderBannedUsersList() {
        bannedUsersListElem.innerHTML = '';
        if (bannedUsers.length === 0) {
            bannedUsersListElem.innerHTML = '<p class="text-gray-500 text-center">No banned users added yet.</p>';
            return;
        }
        bannedUsers.forEach(user => {
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center py-2 px-3 border-b border-gray-600 last:border-b-0 text-gray-200';
            div.innerHTML = `
                <span>${user}</span>
                <button data-user="${user}" class="remove-banned-user-btn text-red-400 hover:text-red-500 transition-colors">
                    <i class="fas fa-times-circle"></i>
                </button>
            `;
            bannedUsersListElem.appendChild(div);
        });

        document.querySelectorAll('.remove-banned-user-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const userToRemove = e.currentTarget.dataset.user;
                removeBannedUser(userToRemove);
            });
        });
    }

    function populateBannedUserSuggestions() {
        bannedUserSuggestionsDatalist.innerHTML = '';
        if (!originalNotFollowingBack || originalNotFollowingBack.length === 0) {
            return;
        }

        const currentInput = bannedUserInput.value.toLowerCase();
        const suggestedUsers = new Set();

        // Suggest users who are currently in the "orange" category and not already banned
        originalNotFollowingBack.forEach(account => {
            const username = account.username;
            const timeInfo = formatTimeDifference(account.timestamp);
            if (timeInfo.category === 'orange' && !bannedUsers.includes(username) && username.toLowerCase().includes(currentInput)) {
                suggestedUsers.add(username);
            }
        });

        Array.from(suggestedUsers).sort().forEach(username => {
            const option = document.createElement('option');
            option.value = username;
            bannedUserSuggestionsDatalist.appendChild(option);
        });
    }

    const bannedUserInputHandler = () => {
        populateBannedUserSuggestions();
    };

    async function addBannedUser(username) {
        if (username && !bannedUsers.includes(username)) {
            bannedUsers.push(username);
            return true;
        }
        return false;
    }

    async function processAndSaveBannedUsers(newUsersAdded = false) {
        if (newUsersAdded && currentFileData) {
            bannedUsers.sort();
            currentFileData.bannedUsers = bannedUsers;
            await saveBannedUsersToFirestore();
        }
        renderBannedUsersList();
    }

    const addBannedUserButtonClickHandler = async () => {
        const username = bannedUserInput.value.trim();
        if (username) {
            const added = await addBannedUser(username);
            if (added) {
                bannedUserInput.value = '';
                await processAndSaveBannedUsers(true);
                showNotification('Banned user added!', 'success');
            } else {
                showNotification('User is already in the banned list.', 'info');
            }
        }
    };

    const addBulkBannedUserButtonClickHandlerForBanned = async () => { // Renamed to avoid conflict
        const text = bulkBannedUserInput.value.trim();
        if (!text) {
            showNotification('Please enter usernames in the bulk input area.', 'info');
            return;
        }

        const usernames = text.split(/[\n,]+/).map(name => name.trim()).filter(name => name.length > 0);
        let anyAdded = false;
        const alreadyInList = [];

        for (const username of usernames) {
            const added = await addBannedUser(username);
            if (added) {
                anyAdded = true;
            } else {
                alreadyInList.push(username);
            }
        }

        if (anyAdded) {
            bulkBannedUserInput.value = '';
            await processAndSaveBannedUsers(true);
            showNotification('Banned users added!', 'success');
            closeBannedUsersAddModalFunc(); // Close modal after bulk add
        } else if (alreadyInList.length > 0) {
            showAlert(`All entered users are already in the banned list: ${alreadyInList.join(', ')}`, 'info');
        } else {
            showNotification('No valid users were entered.', 'info');
        }
    };

    async function removeBannedUser(username) {
        bannedUsers = bannedUsers.filter(user => user !== username);
        await processAndSaveBannedUsers(true);
        showNotification('Banned user removed!', 'info');
    }

    async function saveBannedUsersToFirestore() {
        if (currentUserId && authInstance.currentUser && dbInstance && currentFileData) {
            try {
                const userDocRef = doc(dbInstance, `artifacts/${appId}/users/${currentUserId}/userUploads`, currentFileData.id);
                await setDoc(userDocRef, { 
                    bannedUsers: currentFileData.bannedUsers,
                }, { merge: true });
                console.log('Banned users saved to Firestore for current upload.');
            } catch (error) {
                console.error('Error saving banned users to Firestore:', error);
                showAlert('Failed to save banned users to storage.', 'error');
            }
        } else {
            console.warn('Cannot save banned users: User not authenticated or currentFileData not available.');
        }
    }

    async function handleCheckBannedUsers() {
        let inputUsernames = [];

        // Handle file input
        if (bannedUsersFileInput.files.length > 0) {
            const file = bannedUsersFileInput.files[0];
            const fileExtension = file.name.split('.').pop().toLowerCase();

            if (!['txt', 'html'].includes(fileExtension)) {
                showAlert('Invalid file type. Please upload a .txt or .html file.', 'error');
                return;
            }

            try {
                const fileContent = await file.text();
                if (fileExtension === 'html') {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(fileContent, 'text/html');
                    const preElements = doc.querySelectorAll('pre');
                    let foundData = false;
                    for (const pre of preElements) {
                        try {
                            const jsonData = JSON.parse(pre.textContent);
                            // Check for structure that might contain usernames
                            if (Array.isArray(jsonData) && jsonData.every(item => item.string_list_data)) {
                                inputUsernames = inputUsernames.concat(jsonData.map(item => item.string_list_data[0].value));
                                foundData = true;
                                break;
                            }
                        } catch (e) { /* not JSON or not the right structure */ }
                    }
                    if (!foundData) {
                        const scriptElements = doc.querySelectorAll('script[type="application/json"]');
                        for (const script of scriptElements) {
                            try {
                                const jsonData = JSON.parse(script.textContent);
                                if (Array.isArray(jsonData) && jsonData.every(item => item.string_list_data)) {
                                    inputUsernames = inputUsernames.concat(jsonData.map(item => item.string_list_data[0].value));
                                    foundData = true;
                                    break;
                                }
                            } catch (e) { /* not JSON or not the right structure */ }
                        }
                    }
                    if (!foundData) {
                        showAlert('Could not extract usernames from the HTML file. Ensure it contains Instagram data in expected JSON format within <pre> or <script> tags.', 'error');
                        return;
                    }
                } else { // .txt file
                    inputUsernames = parseUsernamesFromText(fileContent);
                }
            } catch (error) {
                showAlert('Error reading file: ' + error.message, 'error');
                return;
            }
        } else if (bannedUsersTextInput.value.trim()) {
            // Handle text area input
            inputUsernames = parseUsernamesFromText(bannedUsersTextInput.value);
        } else {
            showAlert('Please upload a .txt or .html file or enter usernames/links in the text area.', 'info');
            return;
        }

        // Normalize input usernames (remove duplicates and ensure clean usernames)
        inputUsernames = Array.from(new Set(inputUsernames.map(name => name.toLowerCase())));
        console.log("Input Usernames for check:", inputUsernames);
        console.log("Current Banned Users list:", bannedUsers);

        // Compare against the lowercase version of the bannedUsers list
        const bannedUsersLower = bannedUsers.map(user => user.toLowerCase());
        const matchedUsers = inputUsernames.filter(username => bannedUsersLower.includes(username));

        matchesCountText.textContent = `${matchedUsers.length} match${matchedUsers.length === 1 ? '' : 'es'} found:`;
        matchesList.innerHTML = '';
        if (matchedUsers.length > 0) {
            matchedUsers.forEach(username => {
                const li = document.createElement('li');
                li.innerHTML = `<a href="https://www.instagram.com/${username}/" target="_blank" rel="noopener noreferrer" class="font-medium text-blue-400 hover:underline">${username}</a>`;
                matchesList.appendChild(li);
            });
        } else {
            const li = document.createElement('li');
            li.textContent = 'No matches found.';
            matchesList.appendChild(li);
        }
        bannedUsersMatchesDisplay.classList.remove('hidden');
    }

    function parseUsernamesFromText(text) {
        const instagramLinkRegex = /(?:https?:\/\/)?(?:www\.)?instagram\.com\/([a-zA-Z0-9_.]+)(?:\/)?/g; // Added optional trailing slash
        const atUsernameRegex = /(?<!\w)@([a-zA-Z0-9_.]+)(?!\w)/g;
        const extractedUsernames = new Set();

        // Extract from links
        let match;
        while ((match = instagramLinkRegex.exec(text)) !== null) {
            extractedUsernames.add(match[1]);
        }
        instagramLinkRegex.lastIndex = 0; // Reset regex for next use

        // Extract from @usernames
        while ((match = atUsernameRegex.exec(text)) !== null) {
            // Basic check to avoid common words, could be improved.
            // Ensure it's not just a single character or common punctuation, and doesn't contain '.' which usually indicates a file extension or part of a URL.
            if (match[1].length > 2 && !match[1].includes('.')) { 
                extractedUsernames.add(match[1]);
            }
        }
        atUsernameRegex.lastIndex = 0; // Reset regex for next use

        // Also consider lines/comma-separated values as direct usernames
        // Filter out anything that looks like a URL or an @mention already handled
        const directUsernames = text.split(/[\n,]+/)
                                    .map(name => name.trim())
                                    .filter(name => name.length > 0 && !name.startsWith('http') && !name.startsWith('@'));
        directUsernames.forEach(username => extractedUsernames.add(username));

        return Array.from(extractedUsernames);
    }


    // Function to apply search and time filters and render accounts
    function applyFiltersAndRenderAccounts() {
        let filteredAccounts = [...allNonFollowers]; // Start with the list already filtered by safe users

        const searchTerm = searchInput.value.toLowerCase();
        if (searchTerm) {
            filteredAccounts = filteredAccounts.filter(account =>
                account.username.toLowerCase().includes(searchTerm)
            );
        }

        const timeFilter = timeFilterSelect.value;
        if (timeFilter !== 'all') {
            filteredAccounts = filteredAccounts.filter(account => {
                if (!account.timestamp) return false; // Exclude if no timestamp
                const timeInfo = formatTimeDifference(account.timestamp);
                return timeInfo.category === timeFilter;
            });
        }

        const sortOrder = sortSelect.value; // Get sort order
        filteredAccounts.sort((a, b) => {
            if (sortOrder === 'newest') {
                return (b.timestamp || 0) - (a.timestamp || 0); // Descending by timestamp
            } else if (sortOrder === 'oldest') {
                return (a.timestamp || 0) - (b.timestamp || 0); // Ascending by timestamp
            } else if (sortOrder === 'alpha-asc') {
                return a.username.localeCompare(b.username); // A-Z
            } else if (sortOrder === 'alpha-desc') {
                return b.username.localeCompare(a.username); // Z-A
            } else if (sortOrder === 'color') {
                // Sort by color category: Green, Orange, Red
                const categoryOrder = { 'green': 1, 'orange': 2, 'red': 3, 'unknown': 4 };
                const catA = a.timestamp ? formatTimeDifference(a.timestamp).category : 'unknown';
                const catB = b.timestamp ? formatTimeDifference(b.timestamp).category : 'unknown';
                return categoryOrder[catA] - categoryOrder[catB];
            }
            return 0; // No sort
        });

        renderAccounts(filteredAccounts);
    }

    // New function to apply search and sort filters for Accounts Management list
    function applyAccountsManagementFiltersAndRender() {
        let accountsToDisplay = [];
        let listTitle = "";

        // Re-calculate accountsToRemoveList based on current state
        if (currentFileData) {
            const combinedFollowingSet = new Set(currentFileData.followingList); // Base from uploaded file
            manuallyAddedFollowing.forEach(user => combinedFollowingSet.add(user)); // Add manually added
            manuallyUnfollowedList.forEach(user => combinedFollowingSet.delete(user)); // Remove manually unfollowed

            accountsToRemoveList = accountsManuallyAddedForReview.filter(account =>
                !approvedAccountsList.includes(account.username) &&
                !removedAccountsList.includes(account.username)
            );
            accountsToRemoveList.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
        } else {
            accountsToRemoveList = [];
        }


        if (currentAccountsViewMode === 'toReview') {
            accountsToDisplay = [...accountsToRemoveList];
            listTitle = "Accounts to Review";
        } else if (currentAccountsViewMode === 'approved') {
            // CORRECTED: Directly use approvedAccountsList and map to the expected object format
            accountsToDisplay = approvedAccountsList.map(username => ({ username: username, timestamp: null })); // timestamp is null as approved accounts might not have one
            listTitle = "Approved Accounts";
        } else if (currentAccountsViewMode === 'removed') {
            // Filter accountsManuallyAddedForReview by removedAccountsList
            accountsToDisplay = accountsManuallyAddedForReview.filter(account => removedAccountsList.includes(account.username));
            listTitle = "Removed Accounts";
        }

        accountsListTitle.textContent = listTitle; // Update the title
        console.log(`Accounts Management is reading from: /artifacts/${appId}/users/${currentUserId}/userUploads/${currentFileData ? currentFileData.id : 'N/A'}. Data source:`, accountsToDisplay);
        console.log(`Rendering Accounts Management list in mode: ${currentAccountsViewMode}. Accounts to display:`, accountsToDisplay);



        const searchTerm = accountsSearchInput.value.toLowerCase();
        if (searchTerm) {
            accountsToDisplay = accountsToDisplay.filter(account =>
                account.username.toLowerCase().includes(searchTerm)
            );
        }

        const sortOrder = accountsSortSelect.value;
        accountsToDisplay.sort((a, b) => {
            if (sortOrder === 'newest') {
                return (b.timestamp || 0) - (a.timestamp || 0);
            } else if (sortOrder === 'oldest') {
                return (a.timestamp || 0) - (b.timestamp || 0);
            } else if (sortOrder === 'alpha-asc') {
                return a.username.localeCompare(b.username);
            } else if (sortOrder === 'alpha-desc') {
                return b.username.localeCompare(a.username);
            }
            return 0;
        });
        // NEW CONSOLE LOG: Check the final array after all filters and sorts
        console.log(`Accounts Management final array for rendering:`, accountsToDisplay);

        renderAccountsToRemove(accountsToDisplay);
    }


    // New function to render accounts for Accounts Management list
    function renderAccountsToRemove(accountsToRender) {
        accountsManagementList.innerHTML = ''; // Clear existing list
        if (accountsToRender.length === 0) {
            accountsManagementList.innerHTML = '<p class="text-gray-500 text-center">No accounts to display for this view. Add accounts via the "Add Account" page.</p>';
            return;
        }
        accountsToRender.forEach(account => {
            const timeInfo = account.timestamp ? formatTimeDifference(account.timestamp) : { text: 'N/A', color: 'text-gray-500' };
            const div = document.createElement('div');
            div.className = 'account-list-item';
            div.innerHTML = `
                <a href="https://www.instagram.com/${account.username}/" target="_blank" rel="noopener noreferrer" class="font-medium text-blue-400 hover:underline">
                    ${account.username}
                </a>
                <span class="time-col ${timeInfo.color}">${timeInfo.text}</span>
                <div class="flex space-x-2 ml-4">
                    ${currentAccountsViewMode === 'toReview' ? `
                        <button data-username="${account.username}" class="btn-remove remove-account-btn">REMOVE</button>
                        <button data-username="${account.username}" class="btn-approve approve-account-btn">APPROVE</button>
                    ` : ''}
                </div>
            `;
            accountsManagementList.appendChild(div);
        });

        // Add event listeners for new buttons
        if (currentAccountsViewMode === 'toReview') {
            document.querySelectorAll('.remove-account-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const username = e.currentTarget.dataset.username;
                    handleRemoveAccount(username);
                });
            });
            document.querySelectorAll('.approve-account-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const username = e.currentTarget.dataset.username;
                    handleApproveAccount(username);
                });
            });
        }
    }

    async function handleRemoveAccount(username) {
    // REMOVED: window.open(`https://www.instagram.com/${username}/`, '_blank');
    // The line above that previously opened the user's profile has been removed.

    // Remove from accountsManuallyAddedForReview (if it exists there)
    accountsManuallyAddedForReview = accountsManuallyAddedForReview.filter(account => account.username !== username);
    
    // Add to removedAccountsList
    if (!removedAccountsList.includes(username)) {
        removedAccountsList.push(username);
        removedAccountsList.sort(); // Keep sorted
    }

    // Add to manuallyUnfollowedList (this is the key change for correct following count)
    // This list helps track users you've effectively unfollowed within the app's logic,
    // without altering the original 'followingList' from your uploaded data.
    if (!manuallyUnfollowedList.includes(username)) {
        manuallyUnfollowedList.push(username);
        manuallyUnfollowedList.sort();
    }
    // Also remove from manuallyAddedFollowing if they were added there
    manuallyAddedFollowing = manuallyAddedFollowing.filter(user => user !== username);

    // NEW: Add to bannedUsers list
    // This ensures the user is added to your permanent banned list.
    if (!bannedUsers.includes(username)) {
        bannedUsers.push(username);
        bannedUsers.sort();
    }


    // Update Firestore
    // Save the state of accounts management (approved, removed, accounts for review)
    await saveAccountsManagementState(); 
    // Save the manually added and manually unfollowed lists.
    // Note: The original 'followingList' from your uploaded file is kept as is,
    // and the 'manuallyUnfollowedList' is used to adjust counts for display.
    await saveFollowingAndUnfollowedLists(); 
    // NEW: Save the updated bannedUsers list to Firestore
    await saveBannedUsersToFirestore(); 


    // Recalculate dashboard metrics based on the updated lists
    if (currentFileData) {
        // Re-derive originalNotFollowingBack based on the current state of followingList (from file)
        // and manuallyAddedFollowing, then filter by manuallyUnfollowedList
        const baseFollowingSet = new Set(currentFileData.followingList); // From uploaded file
        manuallyAddedFollowing.forEach(user => baseFollowingSet.add(user)); // Add manually added

        // Filter out manually unfollowed from this combined set to get the effective following
        const effectiveFollowingSet = new Set(Array.from(baseFollowingSet).filter(user => !manuallyUnfollowedList.includes(user)));

        // Re-calculate originalNotFollowingBack (people we follow who don't follow us back)
        // This should compare the effective following set against the followers list from the file.
        originalNotFollowingBack = Array.from(effectiveFollowingSet).filter(username => 
            !new Set(currentFileData.followersList).has(username)
        ).map(username => {
            // Try to find original timestamp if available, otherwise use a placeholder
            const originalAccount = currentFileData.originalNotFollowingBack.find(acc => acc.username === username);
            return { username: username, timestamp: originalAccount ? originalAccount.timestamp : Math.floor(Date.now() / 1000) };
        });

        // Filter by safe users for display
        allNonFollowers = originalNotFollowingBack.filter(account => !safeUsers.includes(account.username));

        // Calculate current total following including manual additions and removals
        const effectiveFollowingCount = effectiveFollowingSet.size;

        updateDashboardMetrics(
            effectiveFollowingCount,
            currentFileData.totalFollowers,
            allNonFollowers.length,
            originalNotFollowingBack.length,
            (currentFileData.recentlyUnfollowedProfiles || []).length
        );
        applyFiltersAndRenderAccounts(); // Re-render dashboard list
    }
    
    // Re-render and update metrics for accounts management
    applyAccountsManagementFiltersAndRender();
    updateAccountsManagementMetrics();
    showNotification(`Account ${username} removed and unfollowed!`, 'success');
}

    async function handleApproveAccount(username) {
        // Remove from accountsManuallyAddedForReview (if it exists there)
        accountsManuallyAddedForReview = accountsManuallyAddedForReview.filter(account => account.username !== username);
        
        // Add to approvedAccountsList
        if (!approvedAccountsList.includes(username)) {
            approvedAccountsList.push(username);
            approvedAccountsList.sort(); // Keep sorted
        }

        // Update Firestore
        await saveAccountsManagementState();

        // Re-render and update metrics
        applyAccountsManagementFiltersAndRender();
        updateAccountsManagementMetrics();
        showNotification(`Account ${username} approved!`, 'success');
    }

    async function saveAccountsManagementState() {
        if (currentUserId && authInstance.currentUser && dbInstance && currentFileData) {
            try {
                const userDocRef = doc(dbInstance, `artifacts/${appId}/users/${currentUserId}/userUploads`, currentFileData.id);
                // Update only the relevant arrays
                await setDoc(userDocRef, { 
                    accountsManuallyAddedForReview: accountsManuallyAddedForReview,
                    approvedAccounts: approvedAccountsList,
                    removedAccounts: removedAccountsList,
                }, { merge: true }); // Use merge: true to only update these fields
                console.log('Accounts management state saved to Firestore for current upload.');
            } catch (error) {
                console.error('Error saving accounts management state to Firestore:', error);
                showAlert('Failed to save accounts management state to storage.', 'error');
            }
        } else {
            console.warn('Cannot save accounts management state: User not authenticated or currentFileData not available.');
        }
    }

    // New: Function to save following and manually unfollowed lists
    async function saveFollowingAndUnfollowedLists() {
        if (currentUserId && authInstance.currentUser && dbInstance && currentFileData) {
            try {
                const userDocRef = doc(dbInstance, `artifacts/${appId}/users/${currentUserId}/userUploads`, currentFileData.id);
                await setDoc(userDocRef, {
                    // followingList: currentFileData.followingList, // We no longer modify this directly here
                    manuallyAddedFollowing: manuallyAddedFollowing,
                    manuallyUnfollowedList: manuallyUnfollowedList
                }, { merge: true });
                console.log('Manually added following and unfollowed lists saved to Firestore.');
            } catch (error) {
                console.error('Error saving following/unfollowed lists to Firestore:', error);
                showAlert('Failed to save following/unfollowed lists to storage.', 'error');
            }
        } else {
            console.warn('Cannot save following/unfollowed lists: User not authenticated or currentFileData not available.');
        }
    }


    // New function to open users by color category
    function openUsersByColor(colorCategory) {
        if (!allNonFollowers || allNonFollowers.length === 0) {
            showAlert('No non-followers data available to open. Please upload your Instagram data first.', 'info');
            return;
        }

        const usersToOpen = allNonFollowers.filter(account => {
            if (!account.timestamp) return false;
            const timeInfo = formatTimeDifference(account.timestamp);
            return timeInfo.category === colorCategory;
        });

        if (usersToOpen.length === 0) {
            showAlert(`No users found in the '${colorCategory}' category.`, 'info');
            return;
        }

        let openedCount = 0;
        usersToOpen.forEach(user => {
            // Open in new tab, with a slight delay to avoid browser blocking pop-ups
            setTimeout(() => {
                window.open(`https://www.instagram.com/${user.username}/`, '_blank');
            }, openedCount * 100); // 100ms delay between tabs
            openedCount++;
        });

        showNotification(`Opening ${openedCount} ${colorCategory} users in new tabs. Please allow pop-ups.`, 'success');
    }

    // New Add Account Page Functions
    function renderAddedAccountsPreview() {
        addedAccountsPreview.innerHTML = '';
        if (manuallyAddedFollowing.length === 0 && accountsManuallyAddedForReview.length === 0) {
            addedAccountsPreview.innerHTML = '<p class="text-gray-500 text-center">Accounts added will appear here.</p>';
            return;
        }

        const allAdded = new Map(); // Use map to store unique usernames and their latest timestamp if available
        
        // Add from manuallyAddedFollowing (these are "real" follows)
        manuallyAddedFollowing.forEach(username => {
            allAdded.set(username, { type: 'Following', timestamp: null }); // No timestamp for this list
        });

        // Add from accountsManuallyAddedForReview (these are for review)
        accountsManuallyAddedForReview.forEach(account => {
            allAdded.set(account.username, { type: 'For Review', timestamp: account.timestamp });
        });

        Array.from(allAdded.entries()).sort((a,b) => a[0].localeCompare(b[0])).forEach(([username, info]) => {
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center py-2 px-3 border-b border-gray-600 last:border-b-0 text-gray-200';
            
            let statusText = '';
            if (info.type === 'Following') {
                statusText = '<span class="text-green-400">Following (Manually Added)</span>';
            } else if (info.type === 'For Review') {
                const timeInfo = info.timestamp ? formatTimeDifference(info.timestamp) : { text: 'N/A', color: 'text-gray-500' };
                statusText = `<span class="text-yellow-400">For Review (${timeInfo.text})</span>`;
            }

            div.innerHTML = `
                <a href="https://www.instagram.com/${username}/" target="_blank" rel="noopener noreferrer" class="font-medium text-blue-400 hover:underline">
                    ${username}
                </a>
                <div class="flex items-center space-x-2">
                    ${statusText}
                    <button data-user="${username}" class="remove-added-account-btn text-red-400 hover:text-red-500 transition-colors" title="Remove from this list">
                        <i class="fas fa-times-circle"></i>
                    </button>
                </div>
            `;
            addedAccountsPreview.appendChild(div);
        });

        document.querySelectorAll('.remove-added-account-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const userToRemove = e.currentTarget.dataset.user;
                removeManuallyAddedAccount(userToRemove);
            });
        });
    }

    async function addManuallyAddedAccount(username) {
        let addedToFollowing = false;
        let addedToReview = false;

        // Add to manuallyAddedFollowing (if not already there)
        if (!manuallyAddedFollowing.includes(username)) {
            manuallyAddedFollowing.push(username);
            manuallyAddedFollowing.sort();
            addedToFollowing = true;
        }

        // Add to accountsManuallyAddedForReview (if not already there)
        if (!accountsManuallyAddedForReview.some(acc => acc.username === username)) {
            accountsManuallyAddedForReview.push({ username: username, timestamp: Math.floor(Date.now() / 1000) });
            accountsManuallyAddedForReview.sort((a,b) => a.username.localeCompare(b.username)); // Sort by username
            addedToReview = true;
        }

        if (addedToFollowing || addedToReview) {
            await saveManuallyAddedState(); // Save both lists
            // Re-process data to update counts
            if (currentFileData) {
                // Recalculate originalNotFollowingBack based on the updated following lists
                const baseFollowingSet = new Set(currentFileData.followingList); // From uploaded file
                manuallyAddedFollowing.forEach(user => baseFollowingSet.add(user)); // Add manually added
                manuallyUnfollowedList.forEach(user => baseFollowingSet.delete(user)); // Remove manually unfollowed

                originalNotFollowingBack = Array.from(baseFollowingSet).filter(username => 
                    !new Set(currentFileData.followersList).has(username)
                ).map(username => {
                    // Try to find original timestamp if available, otherwise use a placeholder
                    const originalAccount = currentFileData.originalNotFollowingBack.find(acc => acc.username === username);
                    return { username: username, timestamp: originalAccount ? originalAccount.timestamp : Math.floor(Date.now() / 1000) };
                });

                allNonFollowers = originalNotFollowingBack.filter(account => !safeUsers.includes(account.username));

                // Calculate current total following including manual additions and removals
                const effectiveFollowingCount = baseFollowingSet.size;

                updateDashboardMetrics(
                    effectiveFollowingCount,
                    currentFileData.totalFollowers,
                    allNonFollowers.length,
                    originalNotFollowingBack.length,
                    (currentFileData.recentlyUnfollowedProfiles || []).length
                );
                applyFiltersAndRenderAccounts();
                applyAccountsManagementFiltersAndRender(); // Update accounts management list
            }
            renderAddedAccountsPreview();
            return true;
        }
        return false;
    }

    async function removeManuallyAddedAccount(username) {
        let removedFromFollowing = false;
        let removedFromReview = false;

        // Remove from manuallyAddedFollowing
        const initialManuallyAddedFollowingSize = manuallyAddedFollowing.length;
        manuallyAddedFollowing = manuallyAddedFollowing.filter(user => user !== username);
        if (manuallyAddedFollowing.length < initialManuallyAddedFollowingSize) {
            removedFromFollowing = true;
        }

        // Remove from accountsManuallyAddedForReview
        const initialAccountsManuallyAddedForReviewSize = accountsManuallyAddedForReview.length;
        accountsManuallyAddedForReview = accountsManuallyAddedForReview.filter(account => account.username !== username);
        if (accountsManuallyAddedForReview.length < initialAccountsManuallyAddedForReviewSize) {
            removedFromReview = true;
        }

        if (removedFromFollowing || removedFromReview) {
            await saveManuallyAddedState();
            // Re-process data to update counts (similar to addManuallyAddedAccount)
            if (currentFileData) {
                // Recalculate originalNotFollowingBack based on the updated following lists
                const baseFollowingSet = new Set(currentFileData.followingList); // From uploaded file
                manuallyAddedFollowing.forEach(user => baseFollowingSet.add(user)); // Add manually added
                manuallyUnfollowedList.forEach(user => baseFollowingSet.delete(user)); // Remove manually unfollowed

                originalNotFollowingBack = Array.from(baseFollowingSet).filter(username => 
                    !new Set(currentFileData.followersList).has(username)
                ).map(username => {
                    // Try to find original timestamp if available, otherwise use a placeholder
                    const originalAccount = currentFileData.originalNotFollowingBack.find(acc => acc.username === username);
                    return { username: username, timestamp: originalAccount ? originalAccount.timestamp : null }; 
                });

                allNonFollowers = originalNotFollowingBack.filter(account => !safeUsers.includes(account.username));

                // Calculate current total following including manual additions and removals
                const effectiveFollowingCount = baseFollowingSet.size;

                updateDashboardMetrics(
                    effectiveFollowingCount,
                    currentFileData.totalFollowers,
                    allNonFollowers.length,
                    originalNotFollowingBack.length,
                    (currentFileData.recentlyUnfollowedProfiles || []).length
                );
                applyFiltersAndRenderAccounts();
                applyAccountsManagementFiltersAndRender(); // Update accounts management list
            }
            renderAddedAccountsPreview();
            showNotification(`Account ${username} removed from manually added lists.`, 'info');
        } else {
            showNotification(`Account ${username} not found in manually added lists.`, 'info');
        }
    }

    async function saveManuallyAddedState() {
        if (currentUserId && authInstance.currentUser && dbInstance && currentFileData) {
            try {
                const userDocRef = doc(dbInstance, `artifacts/${appId}/users/${currentUserId}/userUploads`, currentFileData.id);
                await setDoc(userDocRef, { 
                    manuallyAddedFollowing: manuallyAddedFollowing,
                    accountsManuallyAddedForReview: accountsManuallyAddedForReview,
                    manuallyUnfollowedList: manuallyUnfollowedList,
                    bannedUsers: bannedUsers
                }, { merge: true });
                console.log('Manually added following and review accounts saved to Firestore.');
            } catch (error) {
                console.error('Error saving manually added state to Firestore:', error);
                showAlert('Failed to save manually added accounts to storage.', 'error');
            }
        } else {
            console.warn('Cannot save manually added state: User not authenticated or currentFileData not available.');
        }
    }

const handleAddSingleAccount = async () => {
  const username = singleAddAccountInput.value.trim();
  if (!username) {
    showAlert('Please enter an Instagram username.', 'error');
    return;
  }

  if (!currentUserId || !currentFileData || !dbInstance) {
    showAlert('User data not loaded. Please upload your data first.', 'error');
    return;
  }


  const isAlreadyFollowing = currentFileData.followingList.includes(username);
  const isManuallyAdded = manuallyAddedFollowing.includes(username);

  if (isAlreadyFollowing || isManuallyAdded) {
      showAlert(`Profile '${username}' is already in your following list or has been manually added.`, 'info');
      singleAddAccountInput.value = ''; // Clear input field
      return; // Stop processing this username
  }



  try {

    manuallyAddedFollowing.push(username);
    accountsManuallyAddedForReview.push({
      username: username,
      timestamp: Math.floor(Date.now() / 1000)
    });

    await saveManuallyAddedState();

    applyAccountsManagementFiltersAndRender();
    updateAccountsManagementMetrics();
    renderAddedAccountsPreview();

    showNotification(`Added: ${username}`, 'success');
    singleAddAccountInput.value = '';
    await loadDataForUpload(currentFileData.id); // refresh
  } catch (error) {
    console.error("Error adding account:", error);
    showAlert(`Failed to add account: ${error.message}`, 'error');
  }
};


const handleAddBulkAccounts = async () => {
  const usernamesText = bulkAddAccountInput.value.trim();
  if (!usernamesText) {
    showAlert('Please enter usernames for bulk addition.', 'error');
    return;
  }

  if (!currentUserId || !currentFileData || !dbInstance) {
    showAlert('User data not loaded. Please upload your data first.', 'error');
    return;
  }

  const usernames = usernamesText
    .split(/[\n,]+/)
    .map(u => u.trim())
    .filter(u => u.length > 0);

  if (usernames.length === 0) {
    showAlert('No valid usernames found.', 'error');
    return;
  }

  showLoading(`Adding ${usernames.length} account(s)...`);
  let successCount = 0;

  for (const username of usernames) {
    try {
      const normalizedUsername = username.toLowerCase(); // Normalize username for consistent comparison

      // START OF UPDATED CODE BLOCK: Add duplicate check here
      const isAlreadyFollowing = currentFileData.followingList.includes(normalizedUsername);
      const isManuallyAdded = manuallyAddedFollowing.includes(normalizedUsername);

      if (isAlreadyFollowing || isManuallyAdded) {
        console.warn(`Skipping duplicate profile: ${normalizedUsername}`);
        continue; // Skip to the next username in the loop
      }
      // END OF UPDATED CODE BLOCK

      manuallyAddedFollowing.push(normalizedUsername); // Use normalizedUsername here
      accountsManuallyAddedForReview.push({
        username: normalizedUsername, // Use normalizedUsername here
        timestamp: Math.floor(Date.now() / 1000)
      });

      successCount++;
    } catch (error) {
      console.error(` Failed to add ${username}:`, error);
    }
  }

  hideLoading();
  bulkAddAccountInput.value = "";

  await saveManuallyAddedState();

  applyAccountsManagementFiltersAndRender();
  updateAccountsManagementMetrics();
  renderAddedAccountsPreview();

  showNotification(` ${successCount} accounts added.`, 'success');
};


    // New: Handle "Safe" button click from dashboard
    async function handleSafeUserFromDashboard(username) {
        const added = await addSafeUser(username);
        if (added) {
            await processAndSaveSafeUsers(true);
            showNotification(`Account ${username} added to safe list.`, 'success');
        } else {
            showNotification(`Account ${username} is already in the safe list.`, 'info');
        }
    }

    // New: Handle "Remove" button click from dashboard (simulates unfollow)
    async function handleRemoveFromFollowingFromDashboard(username) {
        // Open Instagram link
        window.open(`https://www.instagram.com/${username}/`, '_blank');

        // Add to manuallyUnfollowedList
        if (!manuallyUnfollowedList.includes(username)) {
            manuallyUnfollowedList.push(username);
            manuallyUnfollowedList.sort();
        }
        // Also remove from manuallyAddedFollowing if they were added there
        manuallyAddedFollowing = manuallyAddedFollowing.filter(user => user !== username);

        // Save updated lists
        await saveFollowingAndUnfollowedLists();

        // Recalculate originalNotFollowingBack and allNonFollowers
        if (currentFileData) {
            const baseFollowingSet = new Set(currentFileData.followingList); // From uploaded file
            manuallyAddedFollowing.forEach(user => baseFollowingSet.add(user)); // Add manually added
            manuallyUnfollowedList.forEach(user => baseFollowingSet.delete(user)); // Remove manually unfollowed

            originalNotFollowingBack = Array.from(baseFollowingSet).filter(username => 
                !new Set(currentFileData.followersList).has(username)
            ).map(username => {
                // Try to find original timestamp if available, otherwise use a placeholder
                const originalAccount = currentFileData.originalNotFollowingBack.find(acc => acc.username === username);
                return { username: username, timestamp: originalAccount ? originalAccount.timestamp : null };
            });

            allNonFollowers = originalNotFollowingBack.filter(account => !safeUsers.includes(account.username));

            // Calculate current total following including manual additions and removals
            const effectiveFollowingCount = baseFollowingSet.size;

            updateDashboardMetrics(
                effectiveFollowingCount,
                currentFileData.totalFollowers,
                allNonFollowers.length,
                originalNotFollowingBack.length,
                (currentFileData.recentlyUnfollowedProfiles || []).length
            );
            applyFiltersAndRenderAccounts(); // Re-render dashboard list
        }
        showNotification(`Account ${username} removed from your following list!`, 'success');
    }


    // Mobile Menu Toggle
    // These event listeners will be set up in window.onload
    const mobileMenuButtonClickHandler = () => {
      mobileMenu.classList.remove('hidden');
    };

    const closeMobileMenuClickHandler = () => {
      mobileMenu.classList.add('hidden');
    };

    // Smooth scrolling for navigation links
    // These event listeners will be set up in window.onload
    const navLinkClickHandler = async function (e) {
        e.preventDefault();
        const targetId = this.getAttribute('href');
        // Add a check to ensure targetId is not just '#' or empty
        if (targetId && targetId !== '#') {
            const targetElement = document.querySelector(targetId);

            if (targetElement) {
                // Hide mobile menu if open
                mobileMenu.classList.add('hidden');
                // Handle section visibility based on navigation
                if (targetId === '#dashboard-section') {
                    if (authInstance.currentUser) {
                        await loadLatestData(); // Ensure latest data is loaded
                        showDashboard();
                    } else {
                        showAlert('Please log in to access the dashboard.', 'info');
                        openAuthModal();
                    }
                } else if (targetId === '#analytics-section') {
                    if (authInstance.currentUser) {
                        // Analytics now calls findAndLoadBestAnalyticsData internally
                        showAnalytics();
                    } else {
                        showAlert('Please log in to access the analytics.', 'info');
                        openAuthModal();
                    }
                } else if (targetId === '#accounts-section') { // New accounts section navigation
                    if (authInstance.currentUser) {
                        await loadLatestData(); // Ensure latest data is loaded
                        showAccountsManagement();
                    } else {
                        showAlert('Please log in to access account management.', 'info');
                        openAuthModal();
                    }
                } else if (targetId === '#banned-users-page-section') { // New banned users page navigation
                    if (authInstance.currentUser) {
                        await loadLatestData(); // Ensure latest data is loaded
                        showBannedUsersPage();
                    } else {
                        showAlert('Please log in to access banned users management.', 'info');
                        openAuthModal();
                    }
                } else if (targetId === '#add-account-page-section') { // New add account page navigation
                    if (authInstance.currentUser) {
                        showAddAccountPage();
                    } else {
                        showAlert('Please log in to manually add accounts.', 'info');
                        openAuthModal();
                    }
                }
                else if (targetId === '#upload') {
                    showUploadSection(currentFileData !== null && currentFileData.fileName, currentFileData ? currentFileData.fileName : '', currentFileData ? file.size : '');
                }
                else {
                    showLandingPage(); // Show all landing sections
                }
                targetElement.scrollIntoView({
                    behavior: 'smooth'
                });
            }
        } else if (targetId === '#dashboard-link' || targetId === '#') { // Special handling for dashboard sidebar link and # for home
            showLandingPage();
        }
    };


    // Event listener for Analytics link (main nav and dashboard sidebar)
    const analyticsLinkClickHandler = async (e) => {
        e.preventDefault();
        if (authInstance.currentUser) {
            // Analytics now calls findAndLoadBestAnalyticsData internally
            showAnalytics();
        } else {
            showAlert('Please log in to access the analytics.', 'info');
            openAuthModal();
        }
    };

    // Event listener for Accounts link
    const accountsLinkClickHandler = (e) => {
        e.preventDefault();
        if (authInstance.currentUser) {
            showAccountsManagement();
        } else {
            showAlert('Please log in to access account management.', 'info');
            openAuthModal();
        }
    };

    // Event listener for Banned Users Page link
    const bannedUsersPageLinkClickHandler = (e) => {
        e.preventDefault();
        if (authInstance.currentUser) {
            showBannedUsersPage();
        } else {
            showAlert('Please log in to access banned users management.', 'info');
            openAuthModal();
        }
    };

    // Event listener for Add Account link
    const addAccountLinkClickHandler = (e) => {
        e.preventDefault();
        if (authInstance.currentUser) {
            showAddAccountPage(); // Now shows the page directly
        } else {
            showAlert('Please log in to manually add accounts.', 'info');
            openAuthModal();
        }
    };

    // Event listener for Settings link
    const settingsLinkClickHandler = (e) => {
        e.preventDefault();
        showAlert('Settings and preferences are coming soon!', 'info');
    };

    // Event listener for Dashboard link in sidebar (This is the "Home" link in sidebar)
    const sidebarHomeLinkClickHandler = (e) => {
        e.preventDefault();
        showLandingPage(); // Direct to landing page as per request
    };

    // New: Functions for "People You Unfollowed" modal
    function openUnfollowedProfilesModal() {
        unfollowedProfilesModal.style.display = 'flex';
        renderUnfollowedProfilesList(currentFileData.recentlyUnfollowedProfiles || []);
    }

    function closeUnfollowedProfilesModalFunc() {
        unfollowedProfilesModal.style.display = 'none';
    }


    // Initial app setup on window load
    window.onload = async function() {
        // Assign all DOM elements here to ensure they are available
        loginBtnNav = document.getElementById('login-btn-nav');
        logoutBtnNav = document.getElementById('logout-btn-nav');
        loginBtnMobile = document.getElementById('login-btn-mobile');
        logoutBtnMobile = document.getElementById('logout-btn-mobile');
        accessPremiumBtn = document.getElementById('access-premium-btn');
        initialUploadArea = document.getElementById('initial-upload-area');
        uploadSuccessState = document.getElementById('upload-success-state');
        uploadedFileName = document.getElementById('uploaded-file-name');
        uploadedFileSize = document.getElementById('uploaded-file-size');
        removeFileBtn = document.getElementById('remove-file-btn');
        findNonFollowersBtn = document.getElementById('find-non-followers-btn');

        uploadArea = document.getElementById('upload-area');
        fileInput = document.getElementById('file-input');
        chooseFileBtn = document.getElementById('choose-file-btn');

        uploadDataModal = document.getElementById('upload-data-modal');
        closeUploadDataModal = document.getElementById('close-upload-data-modal');
        modalUploadArea = document.getElementById('modal-upload-area');
        modalFileInput = document.getElementById('modal-file-input');
        modalChooseFileBtn = document.getElementById('modal-choose-file-btn');

        mobileMenuButton = document.getElementById('mobile-menu-button');
        mobileMenu = document.getElementById('mobile-menu');
        closeMobileMenu = document.getElementById('close-mobile-menu');
        dashboardSection = document.getElementById('dashboard-section');
        heroSection = document.getElementById('hero-section');
        uploadSection = document.getElementById('upload');
        featuresSection = document.getElementById('features');
        dashboardNavLink = document.getElementById('dashboard-nav-link');
        dashboardNavLinkMobile = document.getElementById('dashboard-nav-link-mobile');
        nonFollowersList = document.getElementById('non-followers-list');
        noDataMessage = document.getElementById('no-data-message');
        followingCountElem = document.getElementById('following-count');
        followersCountElem = document.getElementById('followers-count');
        newFollowersCountElem = document.getElementById('newFollowersCount');
        unfollowedYouCountElem = document.getElementById('unfollowedYouCount');
        notFollowingBackFilteredCountElem = document.getElementById('not-following-back-filtered-count');
        notFollowingBackTotalCountElem = document.getElementById('not-following-back-total-count');
        youDontFollowBackCountElem = document.getElementById('you-dont-follow-back-count');
        analyticsSection = document.getElementById('analytics-section'); // Assign analyticsSection
        
        uploadNewDataBtn = document.getElementById('upload-new-data-btn');
        uploadNewDataBtnAnalytics = document.getElementById('upload-new-data-btn-analytics'); // Assign new button
        searchInput = document.getElementById('search-input');
        timeFilterSelect = document.getElementById('time-filter-select');
        sortSelect = document.getElementById('sort-select');
        userIdDisplay = document.getElementById('user-id-display');

        // Sidebar links (dashboard and analytics)
        analyticsLinkDashboard = document.getElementById('analytics-link-sidebar-dashboard');
        dashboardLinkSidebar = document.getElementById('dashboard-link');
        accountsLinkDashboard = document.getElementById('accounts-link-sidebar-dashboard');
        settingsLinkDashboard = document.getElementById('settings-link-sidebar-dashboard');
        bannedUsersLinkSidebarDashboard = document.getElementById('banned-users-link-sidebar-dashboard'); // New

        analyticsLinkAnalytics = document.getElementById('analytics-link-sidebar-analytics');
        dashboardLinkSidebarAnalytics = document.getElementById('dashboard-link-sidebar-analytics');
        accountsLinkAnalytics = document.getElementById('accounts-link-sidebar-analytics');
        settingsLinkAnalytics = document.getElementById('settings-link-sidebar-analytics');
        bannedUsersLinkSidebarAnalytics = document.getElementById('banned-users-link-sidebar-analytics'); // New

        // New Accounts Management elements assignment
        accountsSection = document.getElementById('accounts-section'); // Assign accountsSection
        dashboardLinkSidebarAccounts = document.getElementById('dashboard-link-sidebar-accounts');
        analyticsLinkSidebarAccounts = document.getElementById('analytics-link-sidebar-accounts');
        accountsLinkSidebarAccounts = document.getElementById('accounts-link-sidebar-accounts');
        settingsLinkSidebarAccounts = document.getElementById('settings-link-sidebar-accounts');
        bannedUsersLinkSidebarAccounts = document.getElementById('banned-users-link-sidebar-accounts'); // New
        uploadNewDataBtnAccounts = document.getElementById('upload-new-data-btn-accounts');
        accountsToRemoveCard = document.getElementById('accounts-to-remove-card');
        accountsToRemoveCount = document.getElementById('accounts-to-remove-count');
        totalAccountsRemovedCard = document.getElementById('total-accounts-removed-card');
        totalAccountsRemovedCount = document.getElementById('total-accounts-removed-count');
        approvedAccountsCard = document.getElementById('approved-accounts-card');
        approvedAccountsCount = document.getElementById('approved-accounts-count');
        oldestAccountToRemoveAge = document.getElementById('oldest-account-to-remove-age');
        accountsListTitle = document.getElementById('accounts-list-title');
        accountsSearchInput = document.getElementById('accounts-search-input');
        accountsSortSelect = document.getElementById('accounts-sort-select');
        accountsManagementList = document.getElementById('accounts-management-list');

        // New Banned Users Page elements assignment
        bannedUsersPageSection = document.getElementById('banned-users-page-section'); // Assign bannedUsersPageSection
        dashboardLinkSidebarBanned = document.getElementById('dashboard-link-sidebar-banned');
        analyticsLinkSidebarBanned = document.getElementById('analytics-link-sidebar-banned');
        accountsLinkSidebarBanned = document.getElementById('accounts-link-sidebar-banned');
        settingsLinkSidebarBanned = document.getElementById('settings-link-sidebar-banned');
        bannedUsersLinkSidebarBanned = document.getElementById('banned-users-link-sidebar-banned');
        addBannedUserModalBtn = document.getElementById('add-banned-user-modal-btn'); // New button
        orangeListUsersElem = document.getElementById('orange-list-users'); // New element

        // Existing Banned Users Modal elements (now for adding/removing from permanent list)
        bannedUsersAddModal = document.getElementById('banned-users-add-modal'); // Renamed
        closeBannedUsersAddModal = document.getElementById('close-banned-users-add-modal'); // Renamed
        bannedUserInput = document.getElementById('banned-user-input');
        bannedUserSuggestionsDatalist = document.getElementById('banned-user-suggestions');
        addBannedUserBtn = document.getElementById('add-banned-user-btn');
        bulkBannedUserInput = document.getElementById('bulk-banned-user-input');
        addBulkBannedUserBtn = document.getElementById('add-bulk-banned-user-btn'); // Renamed
        bannedUsersListElem = document.getElementById('banned-users-list');

        // Existing Banned Users Check elements (now on the new page)
        bannedUsersFileInput = document.getElementById('banned-users-file-input');
        bannedUsersTextInput = document.getElementById('banned-users-text-input');
        checkBannedUsersBtn = document.getElementById('check-banned-users-btn');
        bannedUsersMatchesDisplay = document.getElementById('banned-users-matches-display');
        matchesCountText = document.getElementById('matches-count-text');
        matchesList = document.getElementById('matches-list');


        safeUsersBtn = document.getElementById('safe-users-btn');
        safeUsersModal = document.getElementById('safe-users-modal');
        closeSafeUsersModal = document.getElementById('close-safe-users-modal');
        safeUserInput = document.getElementById('safe-user-input');
        safeUserSuggestionsDatalist = document.getElementById('safe-user-suggestions');
        addSafeUserBtn = document.getElementById('add-safe-user-btn');
        bulkSafeUserInput = document.getElementById('bulk-safe-user-input');
        addBulkSafeUserBtn = document.getElementById('add-bulk-safe-user-btn');
        safeUsersListElem = document.getElementById('safe-users-list');
        unfollowedListElem = document.getElementById('unfollowed-list'); // Assign unfollowed list element
        newFollowersListElem = document.getElementById('new-followers-list'); // Assign new followers list element

        authModal = document.getElementById('auth-modal');
        closeAuthModal = document.getElementById('close-auth-modal');
        authEmailInput = document.getElementById('auth-email-input');
        authPasswordInput = document.getElementById('auth-password-input');
        authLoginBtn = document.getElementById('auth-login-btn');
        authSignupBtn = document.getElementById('auth-signup-btn');

        dataUploadSelectorDashboard = document.getElementById('data-upload-selector-dashboard');
        dataUploadSelectorAnalytics = document.getElementById('data-upload-selector-analytics');

        // Assign new button elements
        openGreenUsersBtn = document.getElementById('open-green-users-btn');
        openOrangeUsersBtn = document.getElementById('open-orange-users-btn');
        openRedUsersBtn = document.getElementById('open-red-users-btn');

        // Assign new Add Account elements
        addAccountNavLink = document.getElementById('add-account-nav-link');
        addAccountNavLinkMobile = document.getElementById('add-account-nav-link-mobile');
        addAccountPageSection = document.getElementById('add-account-page-section'); // Now a section
        singleAddAccountInput = document.getElementById('single-add-account-input');
        addSingleAccountBtn = document.getElementById('add-single-account-btn');
        bulkAddAccountInput = document.getElementById('bulk-add-account-input');
        addBulkAccountsBtn = document.getElementById('add-bulk-accounts-btn');
        addedAccountsPreview = document.getElementById('added-accounts-preview');

        // Assign "People You Unfollowed" modal elements
        youDontFollowBackCard = document.getElementById('you-dont-follow-back-card');
        unfollowedProfilesModal = document.getElementById('unfollowed-profiles-modal');
        closeUnfollowedProfilesModal = document.getElementById('close-unfollowed-profiles-modal');
        unfollowedProfilesListElem = document.getElementById('unfollowed-profiles-list');
        followersCard = document.getElementById('followers-card');
        followingCard = document.getElementById('following-card');

        // New: Initialize Approved Users Modal elements
        approvedUsersModal = document.getElementById('approved-users-modal');
        closeApprovedUsersModal = document.getElementById('close-approved-users-modal');
        approvedUsersListElem = document.getElementById('approved-users-list');
        approvedAccountsCard = document.getElementById('approved-accounts-card'); // Initialize the new card
        approvedAccountsCount = document.getElementById('approved-accounts-count'); // Initialize the new count element

        // Modals for Followers and Following Lists
        followersListModal = document.getElementById('followers-list-modal');
        closeFollowersListModal = document.getElementById('close-followers-list-modal');
        followersListContainer = document.getElementById('followers-list-container');
        followersSearchInput = document.getElementById('followers-search-input');

        followingListModal = document.getElementById('following-list-modal');
        closeFollowingListModal = document.getElementById('close-following-list-modal');
        followingListContainer = document.getElementById('following-list-container');
        followingSearchInput = document.getElementById('following-search-input');
        // *** END OF NEW ASSIGNMENTS ***


        // Now that elements are assigned, proceed with Firebase init and event listeners
        const firebaseInitialized = await initializeFirebaseApp();
        if (!firebaseInitialized) {
            console.error("Firebase initialization failed. App will not function correctly.");
        }

        // Add event listeners for drag and drop and file input for the landing page upload area
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault(); // Prevent default to allow drop
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault(); // Prevent default file open
            uploadArea.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            handleFiles(files);
        });

        // Trigger file input when "Choose File" button is clicked
        chooseFileBtn.addEventListener('click', () => {
            fileInput.click();
        });

        // Handle file input change (when user clicks "Choose File" and selects)
        fileInput.addEventListener('change', (event) => {
            handleFiles(event.target.files);
        });

        // Handle "Find My Non-Followers" button click (on landing page upload success state)
        findNonFollowersBtn.addEventListener('click', findNonFollowersButtonClickHandler);

        // Handle "Remove File" button click
        removeFileBtn.addEventListener('click', removeFileButtonClickHandler);

        // Event listeners for Upload Data Modal (these should be inside window.onload too)
        closeUploadDataModal.addEventListener('click', closeUploadDataModalFunc);
        modalUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            modalUploadArea.classList.add('drag-over');
        });
        modalUploadArea.addEventListener('dragleave', () => {
            modalUploadArea.classList.remove('drag-over');
        });
        modalUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            modalUploadArea.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });
        modalChooseFileBtn.addEventListener('click', () => {
            modalFileInput.click();
        });
        modalFileInput.addEventListener('change', (event) => {
            handleFiles(event.target.files);
        });

        // Event listeners for Authentication Modal
        loginBtnNav.addEventListener('click', handleLogin);
        loginBtnMobile.addEventListener('click', handleLogin);
        logoutBtnNav.addEventListener('click', handleLogout);
        logoutBtnMobile.addEventListener('click', handleLogout);
        closeAuthModal.addEventListener('click', closeAuthModalFunc);
        authLoginBtn.addEventListener('click', async () => {
            const email = authEmailInput.value.trim();
            const password = authPasswordInput.value.trim();
            if (!email || !password) { showAlert('Please enter both email and password.', 'error'); return; }
            try { await signInWithEmailAndPassword(authInstance, email, password); showNotification('Logged in successfully!', 'success'); closeAuthModalFunc(); }
            catch (error) { console.error('Login failed:', error); showAlert(`Login failed: ${error.message}`, 'error'); }
        });
        authSignupBtn.addEventListener('click', async () => {
            const email = authEmailInput.value.trim();
            const password = authPasswordInput.value.trim();
            if (!email || !password) { showAlert('Please enter both email and password.', 'error'); return; }
            if (password.length < 6) { showAlert('Password should be at least 6 characters.', 'error'); return; }
            try { await createUserWithEmailAndPassword(authInstance, email, password); showNotification('Account created and logged in successfully!', 'success'); closeAuthModalFunc(); }
            catch (error) { console.error('Signup failed:', error); showAlert(`Signup failed: ${error.message}`, 'error'); }
        });

        // Event listeners for Dashboard filters/search/sort
        searchInput.addEventListener('input', applyFiltersAndRenderAccounts);
        timeFilterSelect.addEventListener('change', applyFiltersAndRenderAccounts);
        sortSelect.addEventListener('change', applyFiltersAndRenderAccounts);

        // Event listeners for Accounts Management filters/search/sort
        accountsSearchInput.addEventListener('input', applyAccountsManagementFiltersAndRender);
        accountsSortSelect.addEventListener('change', applyAccountsManagementFiltersAndRender);

        // Data upload selectors
        dataUploadSelectorDashboard.addEventListener('change', async (e) => {
            await loadDataForUpload(e.target.value);
            // Keep other selectors in sync
            dataUploadSelectorAnalytics.value = e.target.value;
        });
        dataUploadSelectorAnalytics.addEventListener('change', async (e) => {
            await loadDataForUpload(e.target.value);
            // Keep other selectors in sync
            dataUploadSelectorDashboard.value = e.target.value;
        });


        // Mobile Menu Toggle
        mobileMenuButton.addEventListener('click', mobileMenuButtonClickHandler);
        closeMobileMenu.addEventListener('click', closeMobileMenuClickHandler);

        // Event listener for Dashboard link (top nav and sidebar)
        document.getElementById('dashboard-nav-link').addEventListener('click', navLinkClickHandler);
        document.getElementById('dashboard-nav-link-mobile').addEventListener('click', navLinkClickHandler);
        document.getElementById('dashboard-link').addEventListener('click', sidebarHomeLinkClickHandler); // Sidebar "Home" now goes to landing page

        // Analytics links
        document.getElementById('analytics-link-sidebar-dashboard').addEventListener('click', analyticsLinkClickHandler);
        document.getElementById('analytics-link-sidebar-analytics').addEventListener('click', analyticsLinkClickHandler);
        document.getElementById('analytics-link-sidebar-accounts').addEventListener('click', analyticsLinkClickHandler); // New sidebar link
        document.getElementById('analytics-link-sidebar-banned').addEventListener('click', analyticsLinkClickHandler); // New sidebar link

        // Accounts links
        accountsLinkDashboard.addEventListener('click', accountsLinkClickHandler);
        accountsLinkAnalytics.addEventListener('click', accountsLinkClickHandler);
        accountsLinkSidebarAccounts.addEventListener('click', accountsLinkClickHandler); // New sidebar link
        accountsLinkSidebarBanned.addEventListener('click', accountsLinkClickHandler); // New sidebar link

        // Banned Users Page links
        document.getElementById('banned-users-nav-link').addEventListener('click', bannedUsersPageLinkClickHandler);
        document.getElementById('banned-users-nav-link-mobile').addEventListener('click', bannedUsersPageLinkClickHandler);
        bannedUsersLinkSidebarDashboard.addEventListener('click', bannedUsersPageLinkClickHandler);
        bannedUsersLinkSidebarAnalytics.addEventListener('click', bannedUsersPageLinkClickHandler);
        bannedUsersLinkSidebarAccounts.addEventListener('click', bannedUsersPageLinkClickHandler);
        bannedUsersLinkSidebarBanned.addEventListener('click', bannedUsersPageLinkClickHandler);

        // Add Account links
        addAccountNavLink.addEventListener('click', addAccountLinkClickHandler);
        addAccountNavLinkMobile.addEventListener('click', addAccountLinkClickHandler);

        // Settings links
        settingsLinkDashboard.addEventListener('click', settingsLinkClickHandler);
        settingsLinkAnalytics.addEventListener('click', settingsLinkClickHandler);
        settingsLinkSidebarAccounts.addEventListener('click', settingsLinkClickHandler); // New sidebar link
        settingsLinkSidebarBanned.addEventListener('click', settingsLinkClickHandler); // New sidebar link

        // Sidebar Home link for Accounts and Banned sections
        dashboardLinkSidebarAccounts.addEventListener('click', sidebarHomeLinkClickHandler);
        dashboardLinkSidebarBanned.addEventListener('click', sidebarHomeLinkClickHandler);


        // Event listeners for Safe Users modal
        safeUsersBtn.addEventListener('click', openSafeUsersModal);
        closeSafeUsersModal.addEventListener('click', closeSafeUsersModalFunc);
        safeUserInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addSafeUserBtn.click(); // Trigger click of add button
            }
        });
        safeUserInput.addEventListener('input', safeUserInputHandler); // Add listener for suggestions
        addSafeUserBtn.addEventListener('click', addSafeUserButtonClickHandler);
        addBulkSafeUserBtn.addEventListener('click', addBulkSafeUserButtonClickHandler); // Corrected to new function name

        // Event listeners for Banned Users Add modal (NEW)
        addBannedUserModalBtn.addEventListener('click', openBannedUsersAddModal); // Button on the new page
        closeBannedUsersAddModal.addEventListener('click', closeBannedUsersAddModalFunc);
        bannedUserInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addBannedUserBtn.click();
            }
        });
        bannedUserInput.addEventListener('input', bannedUserInputHandler); // Add listener for suggestions
        addBannedUserBtn.addEventListener('click', addBannedUserButtonClickHandler);
        addBulkBannedUserBtn.addEventListener('click', addBulkBannedUserButtonClickHandlerForBanned); // Corrected to new function name
        
        // Event listeners for Banned Users Check functionality (on the new page)
        bannedUsersFileInput.addEventListener('change', handleCheckBannedUsers); // Auto-check on file upload
        checkBannedUsersBtn.addEventListener('click', handleCheckBannedUsers); // Manual check button

        // Handle "Upload New Data" button click in dashboard (opens modal)
        uploadNewDataBtn.addEventListener('click', openUploadDataModal);
        uploadNewDataBtnAnalytics.addEventListener('click', openUploadDataModal); // New button for analytics section
        uploadNewDataBtnAccounts.addEventListener('click', openUploadDataModal); // New button for accounts section

        // Add event listeners for new "Open Users by Color" buttons
        openGreenUsersBtn.addEventListener('click', () => openUsersByColor('green'));
        openOrangeUsersBtn.addEventListener('click', () => openUsersByColor('orange'));
        openRedUsersBtn.addEventListener('click', () => openUsersByColor('red'));

        // Event listeners for Accounts Management stat cards to filter the list
        accountsToRemoveCard.addEventListener('click', () => showAccountsManagement('toReview'));
        totalAccountsRemovedCard.addEventListener('click', () => showAccountsManagement('removed'));
        approvedAccountsCard.addEventListener('click', () => showAccountsManagement('approved'));

        // Event listeners for Add Account Page (formerly modal)
        addSingleAccountBtn.addEventListener('click', handleAddSingleAccount);
        bulkAddAccountInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && e.shiftKey) { // Shift + Enter for new line, Enter alone to add
                // Allow new line
            } else if (e.key === 'Enter') {
                e.preventDefault(); // Prevent default new line
                handleAddBulkAccounts();
            }
        });
        addBulkAccountsBtn.addEventListener('click', handleAddBulkAccounts);

        // New: Event listeners for "People You Unfollowed" modal
        youDontFollowBackCard.addEventListener('click', openUnfollowedProfilesModal);
        closeUnfollowedProfilesModal.addEventListener('click', closeUnfollowedProfilesModalFunc);
// Inside window.onload = async function() { ... }

// Existing Event Listeners (example from your file):
// addBulkAccountsBtn.addEventListener('click', handleAddBulkAccounts);
// youDontFollowBackCard.addEventListener('click', openUnfollowedProfilesModal);
// closeUnfollowedProfilesModal.addEventListener('click', closeUnfollowedProfilesModalFunc); // This is the line you'll find

// --- INSERT NEW EVENT LISTENERS BELOW THIS LINE ---

// Event listeners for clickable metric cards
if (followersCard) { // Always check if element exists before adding listener
    followersCard.addEventListener('click', openFollowersListModal);
}
if (followingCard) { // Always check if element exists before adding listener
    followingCard.addEventListener('click', openFollowingListModal);
}

// Event listeners for closing the new modals
if (closeFollowersListModal) {
    closeFollowersListModal.addEventListener('click', closeFollowersListModalFunc);
}
if (closeFollowingListModal) {
    closeFollowingListModal.addEventListener('click', closeFollowingListModalFunc);
}

// Event listeners for search inputs in new modals
if (followersSearchInput) {
    followersSearchInput.addEventListener('input', (e) => {
        if (currentFileData && currentFileData.followersList) {
            renderAccountList(followersListContainer, currentFileData.followersList, e.target.value);
        }
    });
}

if (followingSearchInput) {
    followingSearchInput.addEventListener('input', (e) => {
        if (currentFileData && currentFileData.followingList) {
            // Re-calculate effective list for search
            const effectiveFollowingSet = new Set(currentFileData.followingList);
            manuallyAddedFollowing.forEach(user => effectiveFollowingSet.add(user));
            manuallyUnfollowedList.forEach(user => effectiveFollowingSet.delete(user));
            const effectiveFollowingList = Array.from(effectiveFollowingSet);

            renderAccountList(followingListContainer, effectiveFollowingList, e.target.value);
        }
    });
}

// Add event listener for the approved users (followers) stat box to open the modal and render the list
const approvedUsersStatBox = document.getElementById('approvedUsersStatBox'); // Assuming you have an ID for this stat box
if (approvedUsersStatBox) {
    approvedUsersStatBox.addEventListener('click', () => {
        const followersListModal = document.getElementById('followersListModal'); // The modal for followers/approved users
        if (followersListModal) {
            followersListModal.classList.remove('hidden');
            if (currentFileData && currentFileData.followersList) {
                renderAccountList(followersListContainer, currentFileData.followersList, ''); // Render all followers initially
            }
        }
    });
}

// --- END OF NEW EVENT LISTENERS ---


        // Initial render of accounts (will show "No data" message)
        renderAccounts([]);
        renderAccountsToRemove([]); // Initial render for accounts management list
        renderOrangeListUsers([]); // Initial render for orange list users
        renderUnfollowedProfilesList([]); // Initial render for unfollowed profiles list
    };

  </script>
</body>
</html>
